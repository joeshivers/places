<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Places">
    <meta name="application-name" content="Places">
    <meta name="msapplication-TileColor" content="#2563eb">
    <meta name="description" content="Track your favorite restaurants and happy hours in NYC">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.svg">
    <link rel="icon" type="image/svg+xml" href="/icons/icon-192x192.svg">
    <link rel="shortcut icon" href="/icons/icon-192x192.svg">
    
    <title>p l a c e s</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        /* CSS Variables for Theme - Clean Black/White */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-hover: #f1f3f4;
            --bg-card: #ffffff;
            --bg-detail: #f8f9fa;
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-tertiary: #666666;
            --border-color: #e0e0e0;
            --border-light: #f0f0f0;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.1);
            --accent-color: #000000;
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-hover: #2a2a2a;
            --bg-card: #111111;
            --bg-detail: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-color: #333333;
            --border-light: #222222;
            --shadow-light: rgba(255, 255, 255, 0.02);
            --shadow-hover: rgba(255, 255, 255, 0.05);
            --accent-color: #ffffff;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
            background: var(--bg-primary);
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Header */
        .header {
            position: relative;
            text-align: center;
            margin-bottom: 5px;
            height: 300px;
            overflow: hidden;
        }

        .header-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
        }

        .header-image::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2;
        }
        
        /* Image Editor Controls */
        .image-editor-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .image-editor-controls.active {
            display: flex;
        }
        
        .image-edit-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .image-edit-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }
        
        .image-position-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .position-slider {
            width: 120px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .position-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .position-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .edit-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 11;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .edit-toggle-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        /* Utility buttons */
        .utility-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }



        .utility-btn {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 50% !important;
            width: 48px !important;
            height: 48px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            font-size: 1.2rem !important;
            background: rgba(255, 255, 255, 0.9) !important;
            color: #333 !important;
            padding: 0 !important;
            margin: 0 !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }

        .utility-btn:hover {
            background: rgba(255, 255, 255, 0.95) !important;
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
        }

        .utility-btn span {
            font-size: 1.2rem !important;
            line-height: 1 !important;
        }

        .header-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0;
            flex-direction: row;
            padding: 40px;
            z-index: 3;
        }

        .header h1 {
            font-size: 5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0;
            text-align: left;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            flex-shrink: 0;
        }

        .header-nav {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            align-self: flex-end;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            padding: 16px;
            position: relative;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--text-primary);
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 0 6px;
        }
        

        .nav-btn:hover {
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 1);
        }

        .nav-btn.active {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        /* Restaurant table */
        .restaurant-table {
            background: transparent;
            border-radius: 0;
            overflow: hidden;
        }

        /* Filters */
        .filters {
            background: transparent;
            padding: 12px 16px;
            display: block;
            text-align: center;
        }

        .happy-hour-filters {
            border: none !important;
        }

        .happy-hour-header {
            border: none !important;
        }

        #happyhour-view .restaurant-table {
            border: none !important;
        }

        .filter-row {
            margin-bottom: 8px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 6px;
        }

        .filter-group label {
            display: inline-block;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 0;
            color: var(--text-primary);
            font-size: 13px;
            vertical-align: middle;
        }

        .filter-group select {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 13px;
            min-width: 110px;
            vertical-align: middle;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .filter-group select:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-group select:focus {
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .filter-group input[type="text"] {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 13px;
            min-width: 160px;
            vertical-align: middle;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-group input[type="text"]:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-group input[type="text"]:focus {
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .filter-group input[type="text"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .filter-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 2px 4px;
        }

        .filter-btn:hover {
            color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.1);
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .filter-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        .clear-filters-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin: 2px 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .clear-filters-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
            background: #dc2626;
        }

        /* Day filter buttons */
        .day-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .day-filter-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-secondary);
            min-width: 45px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 2px 4px;
        }

        .day-filter-btn:hover {
            color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.1);
        }

        .day-filter-btn.active {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .day-filter-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        .day-filter-btn[data-day="all"] {
            min-width: 70px;
        }

        /* Happy Hour Items - Line-based layout matching main page */
        .happy-hour-header {
            margin-top: 32px;
            padding: 8px;
        }

        .hh-header-line {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 16px;
            padding: 12px 16px;
            align-items: center;
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        #happy-hour-list {
            padding: 8px;
        }

        .happy-hour-item {
            background: var(--bg-secondary);
            transition: all 0.2s ease;
            margin-bottom: 1px;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .hh-restaurant-line {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 16px;
            padding: 12px 16px;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .hh-restaurant-line:hover {
            background-color: var(--bg-hover);
        }

        .hh-restaurant-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .hh-restaurant-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .hh-location-separator {
            color: var(--text-tertiary);
            font-weight: 300;
        }

        .hh-restaurant-borough {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .hh-restaurant-neighborhood {
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .hh-restaurant-time {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* View Toggle Buttons */
        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .view-toggle-btn.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .view-toggle-btn:hover:not(.active) {
            background: var(--bg-hover);
        }

        /* Timeline View */
        #timeline-container {
            background: var(--bg-primary);
            border-radius: 0 0 12px 12px;
            overflow: visible;
            border: 1px solid var(--border-color);
            border-top: none;
        }

        .timeline-header {
            margin-top: 32px;
            padding: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-primary);
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            border-radius: 12px 12px 0 0;
            border: 1px solid var(--border-color);
        }
        
        /* Hide table headers when timeline view is active */
        #happy-hour-timeline-view:not(.hidden) ~ #happy-hour-table-view .happy-hour-header,
        #happy-hour-timeline-view:not(.hidden) + .happy-hour-header {
            display: none;
        }

        .timeline-time-slot {
            padding: 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeline-hours {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
        }

        .timeline-hour {
            padding: 16px 8px;
            background: var(--bg-primary);
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }
        
        .timeline-hour:first-child {
            border-radius: 12px 0 0 0;
        }
        
        .timeline-hour:last-child {
            border-radius: 0 12px 0 0;
        }

        .timeline-row {
            display: block;
            background: var(--border-color);
            min-height: 80px;
            margin-bottom: 2px;
            position: relative;
        }

        .timeline-row:hover {
            background-color: var(--bg-hover);
        }

        .timeline-row:last-child {
            border-bottom: none;
        }

        .timeline-restaurant {
            padding: 16px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            border-right: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .timeline-restaurant:hover {
            background-color: var(--bg-hover);
        }

        .timeline-schedule {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            height: 100%;
            position: relative;
        }

        .timeline-slot {
            background: var(--bg-primary);
            min-height: 80px;
        }

        .timeline-bar {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 60px;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
            padding: 8px 12px;
            color: white;
            overflow: hidden;
        }

        .timeline-bar:hover {
            transform: translateY(-50%) scale(1.02);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }

        .timeline-bar-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            line-height: 1.2;
        }

        .timeline-bar-location {
            font-size: 0.75rem;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            line-height: 1.2;
        }

        .timeline-bar-time {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 500;
            margin-top: 2px;
        }

        .timeline-bar.current {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: pulse-bar 2s infinite;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .timeline-bar.current:hover {
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        @keyframes pulse-bar {
            0%, 100% { 
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            50% { 
                opacity: 0.8;
                transform: translateY(-50%) scale(1.02);
            }
        }

        /* Current Time Indicator */
        #timeline-container {
            position: relative;
        }

        .current-time-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #ef4444, #dc2626);
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
            border-radius: 2px;
        }

        .current-time-line::before {
            content: 'NOW';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        /* Mobile responsive for timeline */
        @media (max-width: 768px) {
            .timeline-header {
                grid-template-columns: repeat(7, 1fr);
            }
            
            .timeline-row {
                display: block;
            }
            
            .timeline-hour {
                padding: 8px 4px;
                font-size: 0.8rem;
            }
            
            .timeline-slot {
                min-height: 50px;
                font-size: 0.7rem;
            }
        }

        .hh-restaurant-status {
            font-size: 0.9rem;
            text-align: center;
        }

        .hh-restaurant-status.happening-today {
            color: var(--accent-color);
            font-weight: 600;
        }

        .hh-restaurant-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .hh-restaurant-details {
            background: var(--bg-detail);
            padding: 16px;
            animation: slideDown 0.3s ease-out;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }
        
        .hh-restaurant-details .details-condensed {
            margin-bottom: 12px;
        }
        
        .hh-restaurant-details .detail-row {
            padding: 4px 0;
            font-size: 13px;
            line-height: 1.4;
            border-bottom: 1px solid var(--border-color);
        }
        
        .hh-restaurant-details .detail-row:last-child {
            border-bottom: none;
        }
        
        .hh-restaurant-details .detail-row strong {
            color: var(--text-secondary);
            font-weight: 500;
            margin-right: 8px;
        }
        
        .hh-restaurant-details .day-tags-inline {
            display: inline-flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-left: 8px;
        }
        
        .hh-restaurant-details .details-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
            margin-top: 12px;
        }
        
        .hh-restaurant-details .action-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .hh-restaurant-details .action-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
        }
        
        /* Restaurant details inline expansion styles */
        .restaurant-details {
            background: var(--bg-detail);
            padding: 16px;
            animation: slideDown 0.3s ease-out;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }
        
        .restaurant-details .details-condensed {
            margin-bottom: 12px;
        }
        
        .restaurant-details .detail-row {
            padding: 4px 0;
            font-size: 13px;
            line-height: 1.4;
            border-bottom: 1px solid var(--border-color);
        }
        
        .restaurant-details .detail-row:last-child {
            border-bottom: none;
        }
        
        .restaurant-details .detail-row strong {
            color: var(--text-secondary);
            font-weight: 500;
            margin-right: 8px;
        }
        
        .restaurant-details .details-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
            margin-top: 12px;
        }
        
        .restaurant-details .action-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .restaurant-details .action-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
        }

        /* Mobile responsive for happy hour */
        @media (max-width: 768px) {
            .hh-restaurant-details .details-actions,
            .restaurant-details .details-actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .hh-restaurant-details .action-btn,
            .restaurant-details .action-btn {
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .hh-restaurant-details .detail-row,
            .restaurant-details .detail-row {
                font-size: 12px;
            }
            
            .hh-header-line, .hh-restaurant-line {
                grid-template-columns: 2fr 1fr auto;
                gap: 8px;
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .hh-restaurant-neighborhood, .hh-header-neighborhood {
                display: none;
            }
        }

            .hh-restaurant-name .action-emoji {
                font-size: 12px;
                width: 18px;
                height: 18px;
            }
        }

        @media (max-width: 480px) {
            .hh-header-line, .hh-restaurant-line {
                grid-template-columns: 2fr auto;
                gap: 6px;
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            .hh-restaurant-borough, .hh-header-borough {
                display: none;
            }

            .hh-restaurant-name .action-emoji {
                font-size: 11px;
                width: 16px;
                height: 16px;
            }
        }

        .happy-hour-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .happy-hour-restaurant-name {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
            flex: 1;
            margin-right: 10px;
        }

        .happy-hour-status {
            padding: 4px 8px;
            border-radius: 0;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .happy-hour-location {
            font-weight: 500;
            color: var(--text-tertiary);
            margin-bottom: 15px;
        }

        .happy-hour-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .happy-hour-details > div {
            padding: 8px 12px;
            background: var(--bg-detail);
            border-radius: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .day-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .day-tag {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: var(--bg-hover);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .day-tag:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .day-tag.active-today {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .day-tag.unknown {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: default;
        }

        .day-tag.unknown:hover {
            transform: none;
            background: #f3f4f6;
            color: #9ca3af;
            border-color: var(--border-color);
        }

        .day-tag-consolidated {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
            font-weight: 500;
            display: inline-block;
        }

        /* Happy Hour time display */
        .hh-time-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .hh-days {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .hh-times-primary {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 600;
            background: var(--bg-hover);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            width: fit-content;
        }

        .hh-times-fallback {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .hh-times {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* Happy Hour Grid Editor */
        .happy-hour-grid {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background: var(--bg-secondary);
        }

        .hh-specials-section {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-hover);
            border-radius: 6px;
            border: 1px solid var(--border-light);
        }

        .hh-specials-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .hh-special-group label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .hh-special-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.9rem;
            background: var(--bg-primary);
        }

        .hh-grid-header {
            display: grid;
            grid-template-columns: 100px 120px 120px;
            gap: 10px;
            padding: 12px 8px;
            background: var(--bg-hover);
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .hh-day-row {
            display: grid;
            grid-template-columns: 100px 120px 120px;
            gap: 10px;
            padding: 8px;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }

        /* Ensure time inputs are fully visible and interactive */
        .hh-day-row input[type="time"] {
            min-width: 0;
            width: 100%;
        }

        .hh-day-row input[type="time"]:invalid {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .hh-day-row:last-of-type {
            border-bottom: none;
        }

        .hh-day-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .hh-day-row input[type="time"] {
            padding: 6px 8px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.85rem;
            background: var(--bg-primary);
        }

        .hh-day-row input[type="text"] {
            padding: 6px 8px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.85rem;
            background: var(--bg-primary);
        }

        .hh-bulk-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .bulk-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bulk-btn:hover {
            background: var(--bg-hover);
            border-color: var(--text-secondary);
        }

        .bulk-btn.clear-btn {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .bulk-btn.clear-btn:hover {
            background: #dc2626;
        }


        /* Rich Happy Hour Display */
        .hh-schedule-block {
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-hover);
            border-radius: 6px;
            border: 1px solid var(--border-light);
        }

        .hh-schedule-block:last-child {
            margin-bottom: 0;
        }

        .hh-offers {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .offer-type {
            font-size: 0.75rem;
            background: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Pending Items Styling */
        .pending-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .pending-item-content {
            flex: 1;
        }

        .pending-item-text {
            color: var(--text-primary);
            font-size: 0.9rem;
            word-break: break-word;
        }

        .pending-item-type {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .pending-item-actions {
            display: flex;
            gap: 4px;
        }

        .pending-item-actions button {
            padding: 4px 8px;
            font-size: 0.75rem;
            border: none;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pending-item-actions .btn-danger {
            background: #ef4444;
            color: white;
        }

        .pending-item-actions .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .pending-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0;
            margin-top: 8px;
        }

        .pending-empty {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 20px;
        }

        /* Restaurant items */
        /* Header for restaurants table */
        .restaurants-header {
            margin-top: 32px;
            padding: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-primary);
        }

        .header-line {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr 1fr 1fr;
            gap: 16px;
            padding: 12px 16px;
            align-items: center;
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Container for restaurants - now as a table */
        #restaurants-list {
            padding: 8px;
        }

        .restaurant-item {
            background: var(--bg-secondary);
            transition: all 0.2s ease;
            margin-bottom: 1px;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .restaurant-line {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr 1fr 1fr;
            gap: 16px;
            padding: 12px 16px;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .restaurant-line:hover {
            background-color: var(--bg-hover);
        }

        .restaurant-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .restaurant-borough {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .restaurant-neighborhood {
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .restaurant-cuisine {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .restaurant-status {
            text-align: center;
        }

        .status-btn-inline {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s ease;
            border-radius: 0;
        }

        .status-btn-inline:hover {
            background: var(--bg-hover);
            transform: scale(1.1);
        }

        .restaurant-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .restaurant-tags {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }

        .restaurant-tags .tag {
            background: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            font-style: normal;
            margin-right: 4px;
            display: inline-block;
        }

        .neighborhood-item, .cuisine-item, .type-item {
            background: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            font-style: normal;
            margin-right: 4px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .neighborhood-item:hover, .cuisine-item:hover, .type-item:hover {
            background: var(--text-secondary);
            transform: translateY(-1px);
        }

        /* Inline action emojis */
        .inline-actions {
            margin-left: 8px;
            display: inline-flex;
            gap: 4px;
        }

        .action-emoji {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            cursor: pointer;
            border-radius: 50%;
            font-size: 14px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .action-emoji:hover {
            opacity: 1;
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.1);
        }

        .action-emoji.liked {
            opacity: 1;
        }

        .action-emoji.edit-emoji:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        /* Clickable filter styling */
        .clickable-filter {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 3px;
            padding: 2px 4px;
            margin: -2px -4px;
        }

        .clickable-filter:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.02);
        }

        /* Expanded details section */
        .restaurant-details {
            background: var(--bg-detail);
            padding: 16px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .detail-item strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .detail-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .detail-actions button {
            padding: 6px 12px;
            font-size: 0.8rem;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .detail-actions button:hover {
            background: var(--bg-hover);
        }
        
        .restaurant-item:nth-child(1) { animation-delay: 0.05s; }
        .restaurant-item:nth-child(2) { animation-delay: 0.1s; }
        .restaurant-item:nth-child(3) { animation-delay: 0.15s; }
        .restaurant-item:nth-child(4) { animation-delay: 0.2s; }
        .restaurant-item:nth-child(5) { animation-delay: 0.25s; }
        .restaurant-item:nth-child(6) { animation-delay: 0.3s; }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header-line, .restaurant-line {
                grid-template-columns: 2fr 1fr auto;
                gap: 8px;
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .restaurant-neighborhood, .header-neighborhood {
                display: none;
            }

            .restaurant-cuisine, .header-cuisine {
                display: none;
            }

            .restaurant-type, .header-type {
                display: none;
            }

            .restaurant-tags, .header-tags {
                display: none;
            }

            .restaurant-name {
                font-size: 0.9rem;
            }

            .action-emoji {
                font-size: 12px;
                width: 18px;
                height: 18px;
            }

            .detail-item {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .header-line, .restaurant-line {
                grid-template-columns: 2fr auto;
                gap: 6px;
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            .restaurant-borough, .header-borough {
                display: none;
            }

            .restaurant-name {
                font-size: 0.85rem;
            }

            .action-emoji {
                font-size: 11px;
                width: 16px;
                height: 16px;
            }
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
        }
        
        /* Touch interactions for mobile */
        @media (hover: none) and (pointer: coarse) {
            .restaurant-item:hover {
                transform: none;
                box-shadow: 0 4px 8px var(--shadow-hover);
            }
            
            .restaurant-item:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }

        .restaurant-item:hover {
            box-shadow: 0 8px 16px var(--shadow-hover);
            border-color: var(--accent-color);
            transform: translateY(-4px) scale(1.02);
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .restaurant-name {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
            flex: 1;
            margin-right: 10px;
        }

        .restaurant-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .like-btn, .status-btn {
            background: none;
            border: none;
            border-radius: 0;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .like-btn:hover, .status-btn:hover {
            background-color: var(--bg-hover);
        }

        .like-btn.liked {
            background: none;
        }

        .restaurant-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .restaurant-details > div {
            padding: 8px 12px;
            background: var(--bg-detail);
            border-radius: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .location {
            font-weight: 500;
            color: #4b5563;
            font-size: 0.9rem;
        }

        .borough {
            color: #1f2937;
            font-weight: 600;
        }

        .cuisines, .types, .what-to-order, .happy-hour, .notes {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .website a {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .website a:hover {
            text-decoration: underline;
        }

        /* Edit button */
        .edit-restaurant-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .edit-restaurant-btn:hover {
            background: #2563eb;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 0;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            position: relative;
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        #edit-modal .modal-content {
            max-width: 900px;
            width: 90vw;
        }

        /* Restaurant Details Modal - Wider & Compressed */
        #restaurant-details-modal .modal-content {
            max-width: 900px;
            width: 95vw;
            background: var(--bg-primary);
        }
        
        .restaurant-details-header {
            position: relative;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 24px 32px;
            border-radius: 20px 20px 0 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .restaurant-details-header h2 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .restaurant-details-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 18px;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .restaurant-details-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .restaurant-details-body {
            padding: 24px 32px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .details-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }
        
        .details-section h3 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-item {
            margin-bottom: 8px;
        }
        
        .detail-item:last-child {
            margin-bottom: 0;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--text-tertiary);
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .cuisine-tag, .type-tag {
            display: inline-block;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px 3px 2px 0;
            border: 1px solid var(--border-color);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }
        
        .status-visited {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .status-unvisited {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        
        .liked-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .details-wide-section {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        
        .details-wide-section h3 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .details-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .action-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .action-btn:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .website-link {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            transition: all 0.2s ease;
            display: inline-block;
            font-size: 13px;
        }
        
        .website-link:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .close-button:hover {
            background-color: var(--bg-hover);
            border-radius: 0;
        }

        /* Modern Modal Layout */
        .modal-header {
            padding: 24px 32px 0 32px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            padding-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 32px;
            background: var(--bg-card);
        }

        .modal-footer {
            padding: 20px 32px 32px 32px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-radius: 0 0 12px 12px;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-grid-2:last-child {
            margin-bottom: 0;
        }

        /* Improved Form Elements */
        #edit-modal .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        #edit-modal .form-group input,
        #edit-modal .form-group select,
        #edit-modal .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #edit-modal .form-group input:focus,
        #edit-modal .form-group select:focus,
        #edit-modal .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Checkbox styling */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkmark {
            font-size: 1.1rem;
        }

        /* Location section styling */
        .location-method {
            margin-bottom: 16px;
        }

        .location-method label {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-button-group {
            display: flex;
            gap: 8px;
        }

        .input-button-group input {
            flex: 1;
        }

        .input-button-group button {
            white-space: nowrap;
        }

        .location-divider {
            text-align: center;
            margin: 16px 0;
            position: relative;
        }

        .location-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .location-divider span {
            background: var(--bg-card);
            padding: 0 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            position: relative;
        }

        .location-status {
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        /* Natural Language Happy Hour Input */
        .hh-natural-language {
            background: var(--bg-hover);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .hh-natural-language label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .hh-natural-language textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        .hh-natural-language textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .hh-natural-language button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .hh-natural-language button:hover {
            background: var(--accent-hover);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--text-secondary);
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-secondary {
            background-color: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--text-tertiary);
        }

        .add-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 20px;
        }

        .add-btn:hover {
            background: #059669;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
        
        /* View transitions */
        .view-container {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .view-container:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Staggered animations for filter buttons */
        .filter-btn {
            animation: fadeInUp 0.4s ease-out forwards;
            animation-delay: calc(var(--animation-order) * 0.1s);
        }
        
        /* Pulse animation for active states */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .nav-btn.active {
            animation: pulse 0.6s ease-in-out;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .no-results, .error {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-style: italic;
        }

        .error {
            color: #ef4444;
        }

        #results-count {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 500;
            color: #475569;
        }

        /* Map styles */
        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 0;
            overflow: hidden;
        }

        .map-controls {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .map-info {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .map-info h2 {
            color: var(--text-primary);
        }

        .map-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Tablet styles */
        @media (max-width: 1024px) and (min-width: 769px) {
            #restaurants-list {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 18px;
            }
            
            #happy-hour-list {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 18px;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 4rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .nav {
                gap: 8px;
                margin-bottom: 15px;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1;
                text-align: center;
                min-width: 0;
            }

            .grid {
                grid-template-columns: 1fr;
            }
            
            .restaurant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .restaurant-actions {
                align-self: flex-end;
                width: 100%;
                justify-content: flex-end;
            }

            .restaurant-name {
                font-size: 1.1rem;
            }

            .modal-content {
                margin: 10px;
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 20px);
            }
            
            .restaurant-table {
                padding: 15px !important;
            }

            /* Edit Modal Mobile Adjustments */
            #edit-modal .modal-content {
                width: 95vw;
                max-width: none;
                border-radius: 8px;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding-left: 20px;
                padding-right: 20px;
            }

            .form-grid-2 {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .input-button-group {
                flex-direction: column;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-footer button {
                width: 100%;
            }

            .filter-group {
                display: block;
                margin-right: 0;
                margin-bottom: 15px;
                width: 100%;
            }

            .filter-group select {
                width: 100%;
                min-width: auto;
            }

            .filter-group input[type="text"] {
                width: 100%;
                min-width: auto;
            }

            .import-section {
                margin-bottom: 15px !important;
            }

            .import-section > div {
                flex-direction: column !important;
                gap: 8px !important;
            }

            .import-section input {
                width: 100% !important;
                margin-bottom: 8px;
            }

            /* Restaurant details modal responsive */
            #restaurant-details-modal .modal-content {
                margin: 10px;
                max-width: none;
            }

            #restaurant-details-modal .details-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            #restaurant-details-modal .modal-content > div {
                padding: 15px !important;
            }

            .filter-buttons {
                justify-content: center;
                gap: 6px;
            }

            .filter-btn {
                padding: 6px 12px;
                font-size: 13px;
            }



            .day-tags {
                justify-content: flex-start;
            }

            .location-method {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .location-method button {
                width: 100%;
            }

            /* Larger touch targets for mobile */
            .like-btn, .status-btn, .edit-restaurant-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 8px 12px;
            }

            /* Better form inputs for mobile */
            .form-group input, 
            .form-group select, 
            .form-group textarea {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 0;
            }

            /* Mobile-optimized toggles */

            /* Sticky navigation on mobile */
            .nav {
                position: sticky;
                top: 0;
                background: #f8fafc;
                z-index: 100;
                padding: 10px 0;
                margin: 0 -10px 15px -10px;
                border-bottom: 1px solid #e5e7eb;
            }

            /* Mobile map adjustments */
            .map-container {
                height: 400px;
            }

            /* Better mobile modal */
            .modal {
                padding: 0;
            }

            .modal-content {
                border-radius: 0;
                max-height: 100vh;
                margin: 0;
                width: 100vw;
            }

            /* Mobile-friendly buttons */
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                min-height: 44px;
            }
        }

        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 3.5rem;
            }

            #restaurants-list {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-top: 15px;
            }

            .restaurant-item {
                padding: 15px;
                min-height: 180px;
            }

            #happy-hour-list {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-top: 15px;
            }

            .happy-hour-item {
                padding: 15px;
                min-height: 180px;
            }


            .restaurant-table {
                padding: 10px !important;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* Landscape orientation optimizations */
        @media (max-width: 768px) and (orientation: landscape) {
            .nav {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .nav-btn {
                flex: 0 1 auto;
                min-width: 80px;
            }

            .modal-content {
                max-height: 90vh;
            }
        }

        /* Touch-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            .restaurant-item:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
                transform: translateY(-1px);
            }

            .happy-hour-item:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
                transform: translateY(-1px);
            }

            .nav-btn:hover {
                transform: none;
            }

            .filter-btn:hover {
                background: #f3f4f6;
            }
        }

        /* PWA-style full-screen on mobile */
        @media (display-mode: standalone) {
            .container {
                padding-top: 20px;
            }
        }

        /* Map Layout Styles */
        .map-filters {
            background: transparent;
            padding: 8px 16px;
            display: block;
            text-align: center;
            margin-bottom: 8px;
        }

        .map-filters .filter-row {
            margin-bottom: 6px;
        }

        .map-filters .filter-row:last-child {
            margin-bottom: 0;
        }

        .map-filters .filter-group {
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 6px;
        }

        .map-filters select {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 13px;
            min-width: 110px;
            vertical-align: middle;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .map-filters select:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.15);
        }

        .map-filters select:focus {
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .map-filters .filter-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 2px 4px;
        }

        .map-filters .filter-btn:hover {
            color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.1);
        }

        .map-filters .filter-btn.active {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .map-filters .filter-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        .map-filters .clear-filters-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin: 2px 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .map-filters .clear-filters-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
            background: #dc2626;
        }

        .map-filters .find-me-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin: 2px 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .map-filters .find-me-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            background: #059669;
        }

        .map-layout {
            display: flex;
            height: calc(100vh - 140px);
            gap: 0;
            background: #f8fafc;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .map-sidebar {
            width: 25%;
            min-width: 300px;
            background: transparent;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: transparent;
        }

        .sidebar-header h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .sidebar-count {
            font-size: 14px;
            color: #6b7280;
        }


        .sidebar-restaurants {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .sidebar-restaurant-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(0, 0, 0, 0.02);
            backdrop-filter: blur(10px);
        }

        .sidebar-restaurant-item:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-restaurant-item.active {
            background: var(--bg-hover);
            border-left: 3px solid var(--accent-color);
            box-shadow: 0 4px 12px var(--shadow-hover);
        }

        .sidebar-restaurant-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 14px;
        }

        .sidebar-restaurant-details {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .sidebar-restaurant-badges {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .sidebar-restaurant-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .sidebar-restaurant-badge.visited {
            background: #dcfce7;
            color: #166534;
        }

        .sidebar-restaurant-badge.liked {
            background: #fce7f3;
            color: #be185d;
        }

        .map-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8fafc;
            position: relative;
        }

        .map-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Dark theme adjustments for map layout */
        [data-theme="dark"] .map-filters {
            background: transparent;
        }

        [data-theme="dark"] .map-layout {
            background: #1f2937;
        }

        [data-theme="dark"] .map-sidebar {
            background: transparent;
            border-right-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .sidebar-header {
            background: transparent;
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .sidebar-header h2 {
            color: #f9fafb;
        }

        [data-theme="dark"] .sidebar-count {
            color: #9ca3af;
        }


        [data-theme="dark"] .sidebar-restaurant-item {
            background: rgba(255, 255, 255, 0.02);
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .sidebar-restaurant-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .sidebar-restaurant-item.active {
            background: var(--bg-hover);
            border-left-color: var(--accent-color);
        }


        [data-theme="dark"] .map-main {
            background: #1f2937;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .top-left-nav {
                top: 10px;
                left: 10px;
                gap: 6px;
            }

            .nav-btn-small {
                font-size: 11px;
                padding: 6px 10px;
                min-width: 70px;
            }

            .map-filters .filter-row {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .map-filters .filter-group {
                justify-content: center;
                flex-wrap: wrap;
            }

            .map-filters select {
                min-width: 120px;
                flex: 1;
            }

            .map-layout {
                flex-direction: column;
                height: auto;
            }

            .map-sidebar {
                width: 100%;
                min-width: unset;
                max-height: 40vh;
                order: 2;
            }

            .map-main {
                order: 1;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Utility buttons -->
        <div class="utility-buttons">
            <button class="utility-btn add-btn" onclick="showView('add')" title="Add Restaurant">
                <span>➕</span>
            </button>
            <button class="utility-btn pending-btn" onclick="openPendingModal()" title="Pending Scratchpad">
                <span>📝</span>
            </button>
            <button id="theme-toggle" class="utility-btn theme-toggle" onclick="toggleTheme()">
                <span class="theme-icon">🌙</span>
            </button>
        </div>

        <div class="header">
            <div class="header-image" id="header-image">
                <!-- Random image will be set as background -->
            </div>
            
            <!-- Image Editor Controls -->
            <button class="edit-toggle-btn" id="edit-toggle-btn" onclick="toggleImageEditor()">
                ✏️
            </button>
            
            <div class="image-editor-controls" id="image-editor-controls">
                <div class="image-position-controls">
                    <span style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Position</span>
                    <input type="range" class="position-slider" id="position-slider" 
                           min="0" max="100" value="50" 
                           oninput="adjustImagePosition(this.value)">
                </div>
                <button class="image-edit-btn" onclick="getNewRandomImage()">
                    🎲 New Image
                </button>
                <button class="image-edit-btn" onclick="resetImagePosition()">
                    🎯 Reset Position
                </button>
            </div>
            
            <div class="header-content">
                <h1>p l a c e s</h1>
                <div class="header-nav">
                    <button class="nav-btn active" onclick="showView('database')">Database</button>
                    <button class="nav-btn" onclick="showView('map')">Map</button>
                    <button class="nav-btn" onclick="showView('happyhour')">Happy Hour</button>
                </div>
            </div>
        </div>

        <div id="message-area"></div>

        <!-- Database View -->
        <div id="database-view">
            <div class="restaurant-table" style="margin-bottom: 5px; padding: 5px 20px 5px 20px;">
                <div id="filters" class="filters show">
                    <div class="filter-row">
                        <div class="filter-group">
                            <input type="text" id="search-filter" placeholder="Search restaurants..." onkeyup="applyFilters()" oninput="applyFilters()">
                        </div>
                        
                        <div class="filter-group">
                            <select id="cuisine-filter" onchange="applyFilters()">
                                <option value="">All Cuisines</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select id="neighborhood-filter" onchange="applyFilters()">
                                <option value="">All Neighborhoods</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select id="borough-filter" onchange="applyFilters()">
                                <option value="">All Boroughs</option>
                                <option value="Manhattan">Manhattan</option>
                                <option value="Brooklyn">Brooklyn</option>
                                <option value="Queens">Queens</option>
                                <option value="Bronx">Bronx</option>
                                <option value="Staten Island">Staten Island</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select id="type-filter" onchange="applyFilters()">
                                <option value="">All Types</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select id="tags-filter" onchange="applyFilters()">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="status" data-value="">All Status</button>
                            <button class="filter-btn" data-filter="status" data-value="Visited">Visited</button>
                            <button class="filter-btn" data-filter="status" data-value="Unvisited">Unvisited</button>
                            <button class="filter-btn active" data-filter="liked" data-value="">All Restaurants</button>
                            <button class="filter-btn" data-filter="liked" data-value="true">❤️ Liked Only</button>
                            <button class="filter-btn" data-filter="liked" data-value="false">♡ Not Liked</button>
                            <button class="clear-filters-btn" onclick="clearAllFilters()">Clear All</button>
                        </div>
                    </div>
                </div>

                <div id="results-count"></div>
            </div>

            <div class="restaurants-header">
                <div class="header-line">
                    <div class="header-name">Name</div>
                    <div class="header-borough">Borough</div>
                    <div class="header-neighborhood">Neighborhood</div>
                    <div class="header-cuisine">Cuisine</div>
                    <div class="header-type">Type</div>
                    <div class="header-tags">Tags</div>
                </div>
            </div>
            <div id="restaurants-list"></div>
        </div>

        <!-- Map View -->
        <div id="map-view" class="hidden">
            <!-- Map filters at the top -->
            <div class="map-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <select id="map-borough-filter" onchange="applyMapFilters()">
                            <option value="">All Boroughs</option>
                            <option value="Manhattan">Manhattan</option>
                            <option value="Brooklyn">Brooklyn</option>
                            <option value="Queens">Queens</option>
                            <option value="Bronx">Bronx</option>
                            <option value="Staten Island">Staten Island</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <select id="map-cuisine-filter" onchange="applyMapFilters()">
                            <option value="">All Cuisines</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="status" data-value="" onclick="handleMapFilterClick(this)">All</button>
                        <button class="filter-btn" data-filter="status" data-value="Visited" onclick="handleMapFilterClick(this)">Visited</button>
                        <button class="filter-btn" data-filter="liked" data-value="true" onclick="handleMapFilterClick(this)">❤️ Liked</button>
                    </div>
                    
                    <div class="filter-group">
                        <button class="clear-filters-btn" onclick="clearMapFilters()">Clear Filters</button>
                        <button class="find-me-btn" onclick="findUserLocation()">📍 Find Me</button>
                    </div>
                </div>
            </div>
            
            <div class="map-layout">
                <!-- Sidebar with just restaurant list -->
                <div class="map-sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-count">
                            <span id="map-count">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="sidebar-restaurants" id="map-sidebar-list">
                        <!-- Restaurant list will be populated here -->
                    </div>
                </div>
                
                <!-- Main map container -->
                <div class="map-main">
                    <div id="restaurant-map" class="map-container"></div>
                </div>
            </div>
        </div>

        <!-- Happy Hour View -->
        <div id="happyhour-view" class="hidden">
            <div class="restaurant-table">
                <div class="happy-hour-header" style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h2>○ Happy Hour Guide</h2>
                            <div id="current-time" style="color: #6b7280; font-size: 14px;"></div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="view-toggle" style="display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 4px;">
                                <button id="table-view-btn" class="view-toggle-btn active" onclick="switchHappyHourView('table')">📋 All</button>
                                <button id="timeline-view-btn" class="view-toggle-btn" onclick="switchHappyHourView('timeline')">📺 Today's Guide</button>
                            </div>
                            <div id="happening-now-count" style="background: #ef4444; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 500;">
                                Loading...
                            </div>
                        </div>
                    </div>
                    
                    <div class="happy-hour-filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <div class="day-filter-buttons">
                                    <button class="day-filter-btn active" data-day="all" onclick="toggleDayFilter(this)">All Days</button>
                                    <button class="day-filter-btn" data-day="monday" onclick="toggleDayFilter(this)">Mon</button>
                                    <button class="day-filter-btn" data-day="tuesday" onclick="toggleDayFilter(this)">Tue</button>
                                    <button class="day-filter-btn" data-day="wednesday" onclick="toggleDayFilter(this)">Wed</button>
                                    <button class="day-filter-btn" data-day="thursday" onclick="toggleDayFilter(this)">Thu</button>
                                    <button class="day-filter-btn" data-day="friday" onclick="toggleDayFilter(this)">Fri</button>
                                    <button class="day-filter-btn" data-day="saturday" onclick="toggleDayFilter(this)">Sat</button>
                                    <button class="day-filter-btn" data-day="sunday" onclick="toggleDayFilter(this)">Sun</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <select id="hh-neighborhood-filter" onchange="applyHappyHourFilters()">
                                    <option value="">All Neighborhoods</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <select id="has-food-filter" onchange="applyHappyHourFilters()">
                                    <option value="">All Food Options</option>
                                    <option value="yes">Has Food</option>
                                    <option value="no">Drinks Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <button class="clear-filters-btn" onclick="clearHappyHourFilters()">Clear All Filters</button>
                        </div>
                    </div>
                </div>
                
                <div id="happy-hour-content" style="padding: 20px;">
                    <div id="happy-hour-results-count" style="margin-bottom: 20px; font-weight: 500; color: #374151;"></div>
                    
                    <div class="happy-hour-header">
                        <div class="hh-header-line">
                            <div class="hh-header-name">Name</div>
                            <div class="hh-header-borough">Borough</div>
                            <div class="hh-header-neighborhood">Neighborhood</div>
                            <div class="hh-header-time">Happy Hour</div>
                        </div>
                    </div>
                    
                    <!-- Timeline Header (positioned at same level as table headers) -->
                    <div class="timeline-header hidden" id="timeline-header">
                        <!-- Hours will be dynamically generated -->
                    </div>
                    
                    <!-- Table View -->
                    <div id="happy-hour-table-view">
                        <div id="happy-hour-list"></div>
                    </div>
                    
                    <!-- Timeline View -->
                    <div id="happy-hour-timeline-view" class="hidden">
                        <div id="timeline-container">
                            <div id="timeline-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Restaurant View -->
        <div id="add-view" class="hidden">
            <div class="restaurant-table" style="padding: 20px;">
                <h2>Add New Restaurant</h2>
                
                <!-- Google Maps Import Section -->
                <div class="import-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary);">Quick Import from Google Maps</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="url" id="maps-url" placeholder="Paste Google Maps link here..." style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; background: rgba(255, 255, 255, 0.2); color: var(--text-primary);">
                        <button type="button" onclick="importFromMaps()" style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Import</button>
                    </div>
                    <div id="import-status" style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);"></div>
                </div>
                
                <form id="add-restaurant-form">
                    <div class="grid">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="borough">Borough</label>
                            <select id="borough">
                                <option value="">Select Borough</option>
                                <option value="Manhattan">Manhattan</option>
                                <option value="Brooklyn">Brooklyn</option>
                                <option value="Queens">Queens</option>
                                <option value="Bronx">Bronx</option>
                                <option value="Staten Island">Staten Island</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="neighborhood">Neighborhoods (comma-separated)</label>
                            <input type="text" id="neighborhood" placeholder="e.g., Long Island City, LIC">
                        </div>
                        
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status">
                                <option value="Unvisited">Unvisited</option>
                                <option value="Visited">Visited</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="types">Types (comma-separated)</label>
                        <input type="text" id="types" placeholder="e.g., Fine Dining, Casual, Bar">
                    </div>
                    
                    <div class="form-group">
                        <label for="cuisines">Cuisines (comma-separated)</label>
                        <input type="text" id="cuisines" placeholder="e.g., Italian, American, Asian">
                    </div>
                    
                    <div class="form-group">
                        <label for="tags">Tags (comma-separated)</label>
                        <input type="text" id="tags" placeholder="e.g., #cheap, #near_home, #burger, #date_night">
                    </div>
                    
                    <div class="form-group">
                        <label>📍 Location (choose one method):</label>
                        <div class="location-helper-section">
                            <div class="location-method">
                                <input type="text" id="address-input" placeholder="Enter address: '123 Main St, Brooklyn, NY' or restaurant name + neighborhood">
                                <button type="button" id="geocode-btn" class="btn btn-secondary">📍 Get Coordinates</button>
                            </div>
                            <div class="location-divider"><span>OR</span></div>
                            <div class="location-method">
                                <input type="url" id="maps-link-input" placeholder="Paste Google Maps link (https://maps.google.com/...)">
                                <button type="button" id="parse-link-btn" class="btn btn-secondary">📎 Parse Link</button>
                            </div>
                            <div class="location-divider"><span>OR enter manually below</span></div>
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div class="form-group">
                            <label for="latitude">Latitude (manual)</label>
                            <input type="number" id="latitude" step="any" placeholder="40.7128">
                        </div>
                        
                        <div class="form-group">
                            <label for="longitude">Longitude (manual)</label>
                            <input type="number" id="longitude" step="any" placeholder="-74.0060">
                        </div>
                    </div>
                    
                    <div id="location-status" style="padding: 8px; border-radius: 0; margin-bottom: 10px; display: none;"></div>
                    
                    <!-- Happy Hour Toggle -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="has-happy-hour" onchange="toggleHappyHourDetails()">
                            ○ Has Happy Hour
                        </label>
                    </div>
                    
                    <!-- Happy Hour Editor -->
                    <div class="form-group" id="happy-hour-details" style="display: none;">
                        <label>📅 Happy Hour Schedule</label>
                        <div class="happy-hour-grid" id="happy-hour-grid">
                            <!-- Shared Specials -->
                            <div class="hh-specials-section">
                                <div class="hh-specials-row">
                                    <div class="hh-special-group" style="flex: 1;">
                                        <label>○ Happy Hour Specials</label>
                                        <input type="text" id="hh-shared-specials" placeholder="e.g. $5 cocktails, $8 appetizers, Half-price wine, Free wings" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Natural Language Input -->
                            <div class="hh-natural-language">
                                <label for="hh-natural-input">Quick Entry (Natural Language)</label>
                                <textarea id="hh-natural-input" 
                                         rows="3" 
                                         placeholder="e.g., weekdays 4pm - 6pm, monday to thursday 5-7pm, tue-sat 1pm-3pm"
                                         style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; margin-bottom: 10px;"></textarea>
                                <button type="button" onclick="parseNaturalLanguage(false)" class="btn btn-secondary" style="margin-bottom: 15px;">Parse & Fill Grid</button>
                            </div>
                            
                            <!-- Time Grid -->
                            <div class="hh-grid-header">
                                <div class="hh-grid-day">Day</div>
                                <div class="hh-grid-time">Start Time</div>
                                <div class="hh-grid-time">End Time</div>
                            </div>
                            
                            <div class="hh-day-row" data-day="monday">
                                <div class="hh-day-label">Monday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-day-row" data-day="tuesday">
                                <div class="hh-day-label">Tuesday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-day-row" data-day="wednesday">
                                <div class="hh-day-label">Wednesday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-day-row" data-day="thursday">
                                <div class="hh-day-label">Thursday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-day-row" data-day="friday">
                                <div class="hh-day-label">Friday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-day-row" data-day="saturday">
                                <div class="hh-day-label">Saturday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-day-row" data-day="sunday">
                                <div class="hh-day-label">Sunday</div>
                                <input type="time" class="hh-start-time" />
                                <input type="time" class="hh-end-time" />
                            </div>
                            
                            <div class="hh-bulk-actions">
                                <button type="button" class="bulk-btn" onclick="applyToWeekdays()">Apply to Weekdays</button>
                                <button type="button" class="bulk-btn" onclick="applyToWeekends()">Apply to Weekends</button>
                                <button type="button" class="bulk-btn clear-btn" onclick="clearAllHappyHour()">Clear All</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="website">Website</label>
                        <input type="url" id="website" placeholder="https://restaurant-website.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="what_to_order">What to Order</label>
                        <textarea id="what_to_order" rows="3" placeholder="Recommended dishes..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                    
                    <button type="submit" class="add-btn">Add Restaurant</button>
                </form>
            </div>
        </div>


        <!-- Edit Restaurant Modal -->
        <div id="edit-modal" class="modal hidden">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Restaurant</h2>
                    <button id="close-edit-modal" class="close-button">&times;</button>
                </div>
                
                <div class="modal-body">
                    
                    <form id="edit-restaurant-form">
                        <input type="hidden" id="edit-restaurant-id">
                        
                        <!-- Section 1: Basic Info -->
                        <div class="form-section">
                            <h3 class="section-title">Basic Information</h3>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="edit-name">Restaurant Name *</label>
                                    <input type="text" id="edit-name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-status">Status</label>
                                    <select id="edit-status">
                                        <option value="Unvisited">Unvisited</option>
                                        <option value="Visited">Visited</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="edit-borough">Borough</label>
                                    <select id="edit-borough">
                                        <option value="">Select Borough</option>
                                        <option value="Manhattan">Manhattan</option>
                                        <option value="Brooklyn">Brooklyn</option>
                                        <option value="Queens">Queens</option>
                                        <option value="Bronx">Bronx</option>
                                        <option value="Staten Island">Staten Island</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-neighborhood">Neighborhoods</label>
                                    <input type="text" id="edit-neighborhood" placeholder="e.g., Long Island City, LIC">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 2: Categories -->
                        <div class="form-section">
                            <h3 class="section-title">Categories & Tags</h3>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="edit-types">Types</label>
                                    <input type="text" id="edit-types" placeholder="e.g., Fine Dining, Casual, Bar">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-cuisines">Cuisines</label>
                                    <input type="text" id="edit-cuisines" placeholder="e.g., Italian, American, Asian">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-tags">Tags</label>
                                <input type="text" id="edit-tags" placeholder="e.g., #cheap, #near_home, #burger, #date_night">
                            </div>
                        </div>
                        
                        <!-- Section 3: Location -->
                        <div class="form-section">
                            <h3 class="section-title">Location</h3>
                            <div class="location-helper-section">
                                <div class="location-method">
                                    <label>Search by Address</label>
                                    <div class="input-button-group">
                                        <input type="text" id="edit-address-input" placeholder="Enter address or restaurant name + neighborhood">
                                        <button type="button" id="edit-geocode-btn" class="btn btn-secondary">Get Coordinates</button>
                                    </div>
                                </div>
                                <div class="location-divider"><span>OR</span></div>
                                <div class="location-method">
                                    <label>Paste Google Maps Link</label>
                                    <div class="input-button-group">
                                        <input type="url" id="edit-maps-link-input" placeholder="Paste Google Maps link">
                                        <button type="button" id="edit-parse-link-btn" class="btn btn-secondary">Parse Link</button>
                                    </div>
                                </div>
                                <div class="location-divider"><span>OR enter manually</span></div>
                            </div>
                            
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="edit-latitude">Latitude</label>
                                    <input type="number" id="edit-latitude" step="any" placeholder="40.7128">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-longitude">Longitude</label>
                                    <input type="number" id="edit-longitude" step="any" placeholder="-74.0060">
                                </div>
                            </div>
                            
                            <div id="edit-location-status" class="location-status"></div>
                        </div>
                        
                        <!-- Section 4: Happy Hour -->
                        <div class="form-section">
                            <h3 class="section-title">Happy Hour</h3>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="edit-has-happy-hour" onchange="toggleHappyHourDetails(true)">
                                    <span class="checkmark">○</span>
                                    Has Happy Hour
                                </label>
                            </div>
                            
                            <!-- Happy Hour Editor -->
                            <div class="form-group" id="edit-happy-hour-details" style="display: none;">
                            <label>📅 Happy Hour Schedule</label>
                            <div class="happy-hour-grid" id="edit-happy-hour-grid">
                                <!-- Shared Specials -->
                                <div class="hh-specials-section">
                                    <div class="hh-specials-row">
                                        <div class="hh-special-group" style="flex: 1;">
                                            <label>○ Happy Hour Specials</label>
                                            <input type="text" id="edit-hh-shared-specials" placeholder="e.g. $5 cocktails, $8 appetizers, Half-price wine, Free wings" />
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Natural Language Input -->
                                <div class="hh-natural-language">
                                    <label for="edit-hh-natural-input">Quick Entry (Natural Language)</label>
                                    <textarea id="edit-hh-natural-input" 
                                             rows="3" 
                                             placeholder="e.g., weekdays 4pm - 6pm, monday to thursday 5-7pm, tue-sat 1pm-3pm"
                                             style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; margin-bottom: 10px;"></textarea>
                                    <button type="button" onclick="parseNaturalLanguage(true)" class="btn btn-secondary" style="margin-bottom: 15px;">Parse & Fill Grid</button>
                                </div>
                                
                                <!-- Time Grid -->
                                <div class="hh-grid-header">
                                    <div class="hh-grid-day">Day</div>
                                    <div class="hh-grid-time">Start Time</div>
                                    <div class="hh-grid-time">End Time</div>
                                </div>
                                
                                <div class="hh-day-row" data-day="monday">
                                    <div class="hh-day-label">Monday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-day-row" data-day="tuesday">
                                    <div class="hh-day-label">Tuesday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-day-row" data-day="wednesday">
                                    <div class="hh-day-label">Wednesday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-day-row" data-day="thursday">
                                    <div class="hh-day-label">Thursday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-day-row" data-day="friday">
                                    <div class="hh-day-label">Friday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-day-row" data-day="saturday">
                                    <div class="hh-day-label">Saturday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-day-row" data-day="sunday">
                                    <div class="hh-day-label">Sunday</div>
                                    <input type="time" class="hh-start-time" />
                                    <input type="time" class="hh-end-time" />
                                </div>
                                
                                <div class="hh-bulk-actions">
                                    <button type="button" class="bulk-btn" onclick="applyToWeekdays(true)">Apply to Weekdays</button>
                                    <button type="button" class="bulk-btn" onclick="applyToWeekends(true)">Apply to Weekends</button>
                                    <button type="button" class="bulk-btn clear-btn" onclick="clearAllHappyHour(true)">Clear All</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 5: Details -->
                        <div class="form-section">
                            <h3 class="section-title">Details & Preferences</h3>
                            <div class="form-group">
                                <label for="edit-website">Website</label>
                                <input type="url" id="edit-website" placeholder="https://restaurant-website.com">
                            </div>
                            
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="edit-what-to-order">What to Order</label>
                                    <textarea id="edit-what-to-order" rows="3" placeholder="Recommended dishes..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-notes">Notes</label>
                                    <textarea id="edit-notes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="edit-liked">
                                    <span class="checkmark">♡</span>
                                    Liked
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" form="edit-restaurant-form" class="btn btn-primary">Update Restaurant</button>
                    <button type="button" id="delete-restaurant" class="btn btn-danger">Delete Restaurant</button>
                    <button type="button" id="cancel-edit" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Scratchpad Modal -->
        <div id="pending-modal" class="modal hidden">
            <div class="modal-overlay" onclick="closePendingModal()"></div>
            <div class="modal-content">
                <div class="restaurant-table" style="padding: 20px; max-width: 700px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📝 Scratchpad</h2>
                        <button onclick="closePendingModal()" class="close-button">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            Quick notes for places to add later. Text is auto-saved as you type.
                        </p>
                    </div>
                    
                    <textarea id="scratchpad-text" 
                              placeholder="Start typing your notes here... Add restaurant names, links, thoughts, or anything else you want to remember..."
                              style="width: 100%; height: 400px; padding: 15px; border: 1px solid var(--border-color); border-radius: 0; background: var(--bg-secondary); color: var(--text-primary); font-family: monospace; font-size: 14px; resize: vertical; line-height: 1.5;">
                    </textarea>
                    
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <small id="scratchpad-status" style="color: var(--text-secondary);">Auto-saved to database</small>
                        <button onclick="clearScratchpad()" class="btn btn-danger" style="font-size: 0.8rem; padding: 4px 8px;">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Restaurant Details Modal -->
    <div id="restaurant-details-modal" class="modal hidden">
        <div class="modal-overlay" onclick="closeRestaurantDetails()"></div>
        <div class="modal-content">
            <div class="restaurant-details-header">
                <h2 id="details-restaurant-name">Restaurant Details</h2>
                <button onclick="closeRestaurantDetails()" class="restaurant-details-close">×</button>
            </div>
            
            <div class="restaurant-details-body">
                <div id="restaurant-details-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Restaurant App Core Functionality
        class RestaurantApp {
            constructor() {
                this.currentFilters = {};
                this.currentView = 'database';
                this.restaurants = [];
                this.map = null;
                this.mapMarkers = [];
                this.happyHourFilters = {};
                this.timeUpdateInterval = null;
                this.init();
            }

            async init() {
                // Load initial data
                await this.loadFilterOptions();
                await this.loadRestaurants();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Add window resize handler for map
                window.addEventListener('resize', () => {
                    if (this.map && this.currentView === 'map') {
                        setTimeout(() => {
                            this.map.invalidateSize();
                        }, 100);
                    }
                });

                // If map view is already selected, initialize it
                if (this.currentView === 'map') {
                    setTimeout(() => {
                        this.initializeMap();
                    }, 500);
                }
                
                // Show stats if we have restaurants
                if (this.restaurants.length > 0) {
                }
            }

            setupEventListeners() {
                // Add restaurant form
                document.getElementById('add-restaurant-form')?.addEventListener('submit', (e) => this.handleAddRestaurant(e));
                
                // Filter buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('filter-btn')) {
                        this.handleFilterClick(e.target);
                    }
                });

                // Location helper buttons
                document.getElementById('geocode-btn')?.addEventListener('click', () => this.geocodeAddress());
                document.getElementById('parse-link-btn')?.addEventListener('click', () => this.parseGoogleMapsLink());
            }

            async loadFilterOptions() {
                try {
                    // Load cuisines
                    const cuisinesResponse = await fetch('/api/cuisines');
                    const cuisines = await cuisinesResponse.json();
                    const cuisineSelect = document.getElementById('cuisine-filter');
                    const mapCuisineSelect = document.getElementById('map-cuisine-filter');
                    cuisines.forEach(cuisine => {
                        const option = document.createElement('option');
                        option.value = cuisine.name;
                        option.textContent = cuisine.name;
                        cuisineSelect.appendChild(option);
                        
                        // Also add to map filter
                        const mapOption = document.createElement('option');
                        mapOption.value = cuisine.name;
                        mapOption.textContent = cuisine.name;
                        mapCuisineSelect.appendChild(mapOption);
                    });

                    // Load neighborhoods for both main filter and happy hour filter
                    const neighborhoodsResponse = await fetch('/api/neighborhoods');
                    const neighborhoods = await neighborhoodsResponse.json();
                    const mainNeighborhoodSelect = document.getElementById('neighborhood-filter');
                    const hhNeighborhoodSelect = document.getElementById('hh-neighborhood-filter');
                    neighborhoods.forEach(neighborhood => {
                        // Add to main database filter
                        const mainOption = document.createElement('option');
                        mainOption.value = neighborhood;
                        mainOption.textContent = neighborhood;
                        mainNeighborhoodSelect.appendChild(mainOption);
                        
                        // Add to happy hour filter
                        const hhOption = document.createElement('option');
                        hhOption.value = neighborhood;
                        hhOption.textContent = neighborhood;
                        hhNeighborhoodSelect.appendChild(hhOption);
                    });

                    // Load types
                    const typesResponse = await fetch('/api/types');
                    const types = await typesResponse.json();
                    const typeSelect = document.getElementById('type-filter');
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.textContent = type.name;
                        typeSelect.appendChild(option);
                    });

                    // Load tags
                    const tagsResponse = await fetch('/api/tags');
                    const tags = await tagsResponse.json();
                    const tagsSelect = document.getElementById('tags-filter');
                    tags.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag.name;
                        option.textContent = tag.name;
                        tagsSelect.appendChild(option);
                    });

                } catch (error) {
                    console.error('Error loading filter options:', error);
                }
            }


            async loadRestaurants() {
                try {
                    const queryParams = new URLSearchParams();
                    Object.keys(this.currentFilters).forEach(key => {
                        if (this.currentFilters[key]) {
                            queryParams.append(key, this.currentFilters[key]);
                        }
                    });
                    
                    // Set high limit to load all restaurants
                    queryParams.append('limit', '10000');
                    
                    const response = await fetch(`/api/restaurants?${queryParams}`);
                    this.restaurants = await response.json();
                    
                    this.renderRestaurants();
                    this.updateResultsCount();
                } catch (error) {
                    console.error('Error loading restaurants:', error);
                    document.getElementById('restaurants-list').innerHTML = '<div class="error">Error loading restaurants</div>';
                }
            }

            renderRestaurants() {
                const restaurantsList = document.getElementById('restaurants-list');
                
                if (this.restaurants.length === 0) {
                    restaurantsList.innerHTML = '<div class="no-results">No restaurants found</div>';
                    return;
                }
                
                restaurantsList.innerHTML = '';
                
                this.restaurants.forEach(restaurant => {
                    const restaurantElement = this.createRestaurantElement(restaurant);
                    restaurantsList.appendChild(restaurantElement);
                });
                
                // Add edit buttons after rendering
                if (window.addEditButtonsToRestaurants) {
                    window.addEditButtonsToRestaurants();
                }
            }

            createRestaurantElement(restaurant) {
                const restaurantDiv = document.createElement('div');
                restaurantDiv.className = 'restaurant-item';
                restaurantDiv.setAttribute('data-restaurant-id', restaurant.id);
                
                const statusIcon = restaurant.status === 'Visited' ? '✅' : '⭕';
                const likedIcon = restaurant.liked ? '❤️' : '♡';
                
                // Create compact line format
                restaurantDiv.innerHTML = `
                    <div class="restaurant-line" onclick="toggleRestaurantDetails(${restaurant.id})">
                        <div class="restaurant-name">
                            ${restaurant.name}
                            <span class="inline-actions">
                                <span class="action-emoji ${restaurant.liked ? 'liked' : ''}" 
                                      onclick="event.stopPropagation(); toggleLiked(${restaurant.id}, ${!restaurant.liked})" 
                                      title="Toggle liked status">
                                    ${likedIcon}
                                </span>
                                <span class="action-emoji" 
                                      onclick="event.stopPropagation(); toggleStatus(${restaurant.id})" 
                                      title="Toggle visited status">
                                    ${statusIcon}
                                </span>
                                <span class="action-emoji edit-emoji" 
                                      onclick="event.stopPropagation(); window.restaurantEditor.openEditModal(${restaurant.id})" 
                                      title="Edit restaurant">
                                    ⚪
                                </span>
                            </span>
                        </div>
                        <div class="restaurant-borough ${restaurant.borough ? 'clickable-filter' : ''}" 
                             ${restaurant.borough ? `onclick="event.stopPropagation(); filterByBorough('${restaurant.borough}')" title="Filter by ${restaurant.borough}"` : ''}>
                            ${restaurant.borough || '-'}
                        </div>
                        <div class="restaurant-neighborhood">
                            ${restaurant.neighborhoods && restaurant.neighborhoods.length ? 
                                restaurant.neighborhoods.map(neighborhood => 
                                    `<span class="neighborhood-item" onclick="event.stopPropagation(); filterByNeighborhood('${neighborhood}')" title="Filter by ${neighborhood}">${neighborhood}</span>`
                                ).join('') : '-'
                            }
                        </div>
                        <div class="restaurant-cuisine">
                            ${restaurant.cuisines && restaurant.cuisines.length ? 
                                restaurant.cuisines.map(cuisine => 
                                    `<span class="cuisine-item" onclick="event.stopPropagation(); filterByCuisine('${cuisine}')" title="Filter by ${cuisine}">${cuisine}</span>`
                                ).join('') : '-'
                            }
                        </div>
                        <div class="restaurant-type">
                            ${restaurant.types && restaurant.types.length ? 
                                restaurant.types.map(type => 
                                    `<span class="type-item" onclick="event.stopPropagation(); filterByType('${type}')" title="Filter by ${type}">${type}</span>`
                                ).join('') : '-'
                            }
                        </div>
                        <div class="restaurant-tags">
                            ${restaurant.tags && restaurant.tags.length ? 
                                restaurant.tags.map(tag => `<span class="tag">${tag.name}</span>`).join('') : '-'
                            }
                        </div>
                    </div>
                    
                    <div class="restaurant-details" id="restaurant-details-${restaurant.id}" style="display: none;">
                        <div class="details-condensed">
                            ${restaurant.borough ? `<div class="detail-row"><strong>Borough:</strong> ${restaurant.borough}</div>` : ''}
                            ${restaurant.neighborhoods && restaurant.neighborhoods.length ? `<div class="detail-row"><strong>Neighborhood:</strong> ${restaurant.neighborhoods.join(', ')}</div>` : ''}
                            ${restaurant.address ? `<div class="detail-row"><strong>Address:</strong> ${restaurant.address}</div>` : ''}
                            ${restaurant.cuisines && restaurant.cuisines.length ? `<div class="detail-row"><strong>Cuisine:</strong> ${restaurant.cuisines.join(', ')}</div>` : ''}
                            ${restaurant.types && restaurant.types.length ? `<div class="detail-row"><strong>Type:</strong> ${restaurant.types.join(', ')}</div>` : ''}
                            ${restaurant.tags && restaurant.tags.length ? `<div class="detail-row"><strong>Tags:</strong> ${restaurant.tags.map(tag => tag.name).join(', ')}</div>` : ''}
                            ${restaurant.happy_hour ? `<div class="detail-row"><strong>Happy Hour:</strong> ${restaurant.happy_hour}</div>` : ''}
                            ${restaurant.website_link ? `<div class="detail-row"><strong>Website:</strong> <a href="${restaurant.website_link}" target="_blank">${restaurant.website_link}</a></div>` : ''}
                            ${restaurant.what_to_order ? `<div class="detail-row"><strong>What to Order:</strong> ${restaurant.what_to_order}</div>` : ''}
                            ${restaurant.notes ? `<div class="detail-row"><strong>Notes:</strong> ${restaurant.notes}</div>` : ''}
                        </div>
                        
                        <div class="details-actions">
                            <button onclick="event.stopPropagation(); toggleLiked(${restaurant.id}, ${!restaurant.liked})" 
                                    class="action-btn">
                                ${restaurant.liked ? '❤️ Unlike' : '♡ Like'}
                            </button>
                            <button onclick="event.stopPropagation(); toggleStatus(${restaurant.id})" 
                                    class="action-btn">
                                ${restaurant.status === 'Visited' ? '✅ Mark Unvisited' : '📍 Mark Visited'}
                            </button>
                            <button onclick="event.stopPropagation(); window.restaurantEditor.openEditModal(${restaurant.id})" 
                                    class="action-btn">
                                ✏️ Edit
                            </button>
                        </div>
                    </div>
                `;
                
                return restaurantDiv;
            }

            updateResultsCount() {
                const resultsCount = document.getElementById('results-count');
                if (resultsCount) {
                    // Only show count if filters are applied
                    const hasActiveFilters = Object.values(this.currentFilters).some(filter => filter && filter.length > 0);
                    
                    if (hasActiveFilters) {
                        resultsCount.textContent = `${this.restaurants.length} restaurant${this.restaurants.length !== 1 ? 's' : ''} found`;
                        resultsCount.style.display = 'block';
                    } else {
                        resultsCount.style.display = 'none';
                    }
                }
            }

            handleFilterClick(filterBtn) {
                const filterType = filterBtn.getAttribute('data-filter');
                
                // Remove active class from all buttons in this filter group
                document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                filterBtn.classList.add('active');
                
                // Apply all filters
                applyFilters();
            }

            async handleAddRestaurant(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    borough: document.getElementById('borough').value,
                    neighborhood: document.getElementById('neighborhood').value.trim(),
                    status: document.getElementById('status').value,
                    has_happy_hour: document.getElementById('has-happy-hour').checked,
                    happy_hour_data: document.getElementById('has-happy-hour').checked ? collectHappyHourData(false) : null,
                    website_link: document.getElementById('website').value.trim(),
                    what_to_order: document.getElementById('what_to_order').value.trim(),
                    notes: document.getElementById('notes').value.trim(),
                    latitude: this.parseFloat(document.getElementById('latitude').value),
                    longitude: this.parseFloat(document.getElementById('longitude').value),
                    cuisines: this.parseCommaSeparated(document.getElementById('cuisines').value),
                    types: this.parseCommaSeparated(document.getElementById('types').value),
                    neighborhoods: this.parseCommaSeparated(document.getElementById('neighborhood').value),
                    tags: this.parseCommaSeparated(document.getElementById('tags').value)
                };

                if (!formData.name) {
                    this.showMessage('Restaurant name is required', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/restaurants', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to add restaurant');
                    }

                    this.showMessage('Restaurant added successfully!', 'success');
                    document.getElementById('add-restaurant-form').reset();
                    
                    // Clear location helper fields and status
                    document.getElementById('address-input').value = '';
                    document.getElementById('maps-link-input').value = '';
                    document.getElementById('location-status').style.display = 'none';
                    
                    // Refresh data
                        await this.loadRestaurants();
                    

                } catch (error) {
                    console.error('Error adding restaurant:', error);
                    this.showMessage('Error adding restaurant: ' + error.message, 'error');
                }
            }

            initializeMap(retryCount = 0) {
                try {
                    if (this.map) {
                        // Map already exists, just invalidate size and return
                        setTimeout(() => {
                            this.map.invalidateSize();
                        }, 100);
                        return;
                    }

                    console.log('Initializing map...');
                    
                    // Check if container exists and is visible
                    const container = document.getElementById('restaurant-map');
                    if (!container) {
                        console.error('Map container not found');
                        return;
                    }
                    
                    // Check if container has dimensions
                    const rect = container.getBoundingClientRect();
                    if (rect.width === 0 || rect.height === 0) {
                        if (retryCount < 5) {
                            console.warn(`Map container has no dimensions, retrying... (${retryCount + 1}/5)`);
                            setTimeout(() => this.initializeMap(retryCount + 1), 500);
                            return;
                        } else {
                            console.error('Map container still has no dimensions after retries');
                            return;
                        }
                    }

                    // Initialize map centered on NYC
                    this.map = L.map('restaurant-map').setView([40.7128, -74.0060], 11);

                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(this.map);

                    // Force map to recalculate size after tiles load
                    setTimeout(() => {
                        if (this.map) {
                            this.map.invalidateSize();
                            console.log('Map size invalidated');
                        }
                    }, 200);

                    this.loadRestaurantsOnMap();
                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }

            async loadRestaurantsOnMap() {
                try {
                    // Clear existing markers
                    this.mapMarkers.forEach(marker => {
                        this.map.removeLayer(marker);
                    });
                    this.mapMarkers = [];

                    // Get current filters for map
                    const queryParams = new URLSearchParams();
                    Object.keys(this.currentFilters).forEach(key => {
                        if (this.currentFilters[key]) {
                            queryParams.append(key, this.currentFilters[key]);
                        }
                    });
                    
                    // Set high limit for map as well
                    queryParams.append('limit', '10000');

                    const response = await fetch(`/api/restaurants?${queryParams}`);
                    const restaurants = await response.json();

                    // Filter restaurants that have coordinates
                    const restaurantsWithCoords = restaurants.filter(r => r.latitude && r.longitude);

                    // Add markers for each restaurant
                    restaurantsWithCoords.forEach(restaurant => {
                        const marker = this.createRestaurantMarker(restaurant);
                        marker.addTo(this.map);
                        this.mapMarkers.push(marker);
                    });

                    // Update map count
                    const mapCount = document.getElementById('map-count');
                    if (mapCount) {
                        mapCount.textContent = `${restaurantsWithCoords.length} restaurants on map`;
                    }

                    // Populate sidebar with restaurant list
                    this.populateSidebar(restaurantsWithCoords);

                } catch (error) {
                    console.error('Error loading restaurants on map:', error);
                    const mapCount = document.getElementById('map-count');
                    if (mapCount) {
                        mapCount.textContent = 'Error loading restaurants';
                    }
                }
            }

            createRestaurantMarker(restaurant) {
                const statusIcon = restaurant.status === 'Visited' ? '✅' : '⭕';
                const likedIcon = restaurant.liked ? '❤️' : '♡';
                
                // Choose marker color based on status and liked
                let markerColor = '#6b7280'; // gray for unvisited
                if (restaurant.status === 'Visited') {
                    markerColor = restaurant.liked ? '#ef4444' : '#10b981'; // red for liked visited, green for visited
                }

                // Create custom icon
                const icon = L.divIcon({
                    html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                    popupAnchor: [0, -10],
                    className: 'custom-marker'
                });

                const marker = L.marker([restaurant.latitude, restaurant.longitude], { icon });

                // Create popup content
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">${restaurant.name}</h3>
                        <div style="margin-bottom: 8px; color: #6b7280; font-size: 14px;">
                            <strong>${restaurant.borough || ''}</strong>
                            ${restaurant.neighborhoods && restaurant.neighborhoods.length ? ` • ${restaurant.neighborhoods.join(', ')}` : ''}
                        </div>
                        <div style="margin-bottom: 8px; font-size: 14px;">
                            ${statusIcon} ${restaurant.status} ${likedIcon}
                        </div>
                        ${restaurant.cuisines && restaurant.cuisines.length ? 
                            `<div style="margin-bottom: 8px; font-size: 14px;">🍽️ ${restaurant.cuisines.join(', ')}</div>` : ''
                        }
                        ${restaurant.what_to_order ? 
                            `<div style="margin-bottom: 8px; font-size: 14px;">🍴 ${restaurant.what_to_order}</div>` : ''
                        }
                        ${restaurant.website_link ? 
                            `<div style="margin-bottom: 8px;">
                                <a href="${restaurant.website_link}" target="_blank" style="color: var(--accent-color); text-decoration: none;">🌐 Website</a>
                            </div>` : ''
                        }
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button onclick="toggleLiked(${restaurant.id}, ${!restaurant.liked})" 
                                    style="background: none; border: 1px solid #d1d5db; border-radius: 0; padding: 4px 8px; cursor: pointer; font-size: 16px;">
                                ${likedIcon}
                            </button>
                            <button onclick="toggleStatus(${restaurant.id})" 
                                    style="background: none; border: 1px solid #d1d5db; border-radius: 0; padding: 4px 8px; cursor: pointer; font-size: 16px;">
                                ${statusIcon}
                            </button>
                            <button onclick="window.restaurantEditor.openEditModal(${restaurant.id})" 
                                    style="background: var(--accent-color); color: white; border: none; border-radius: 0; padding: 4px 8px; cursor: pointer; font-size: 14px;">
                                ✏️
                            </button>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                
                // Store restaurant data with marker for sidebar interaction
                marker.restaurantData = restaurant;
                
                // Add click handler to highlight sidebar item when marker is clicked
                marker.on('click', () => {
                    this.highlightRestaurant(restaurant.id);
                });
                
                return marker;
            }

            populateSidebar(restaurants) {
                const sidebarList = document.getElementById('map-sidebar-list');
                if (!sidebarList) return;

                // Clear existing items
                sidebarList.innerHTML = '';

                // Sort restaurants by name
                const sortedRestaurants = restaurants.sort((a, b) => a.name.localeCompare(b.name));

                sortedRestaurants.forEach(restaurant => {
                    const item = document.createElement('div');
                    item.className = 'sidebar-restaurant-item';
                    item.setAttribute('data-restaurant-id', restaurant.id);

                    const badges = [];
                    if (restaurant.status === 'Visited') {
                        badges.push('<span class="sidebar-restaurant-badge visited">Visited</span>');
                    }
                    if (restaurant.liked) {
                        badges.push('<span class="sidebar-restaurant-badge liked">❤️ Liked</span>');
                    }

                    item.innerHTML = `
                        <div class="sidebar-restaurant-name">${restaurant.name}</div>
                        <div class="sidebar-restaurant-details">
                            ${restaurant.borough || ''} ${restaurant.neighborhoods && restaurant.neighborhoods.length ? `• ${restaurant.neighborhoods.join(', ')}` : ''}
                            ${restaurant.cuisines && restaurant.cuisines.length ? `<br>🍽️ ${restaurant.cuisines.join(', ')}` : ''}
                        </div>
                        ${badges.length > 0 ? `<div class="sidebar-restaurant-badges">${badges.join('')}</div>` : ''}
                    `;

                    // Add click handler to zoom to restaurant on map
                    item.addEventListener('click', () => {
                        this.highlightRestaurant(restaurant.id);
                        this.zoomToRestaurant(restaurant);
                    });

                    sidebarList.appendChild(item);
                });
            }

            highlightRestaurant(restaurantId) {
                // Remove active class from all sidebar items
                document.querySelectorAll('.sidebar-restaurant-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Add active class to clicked item
                const clickedItem = document.querySelector(`[data-restaurant-id="${restaurantId}"]`);
                if (clickedItem) {
                    clickedItem.classList.add('active');
                    
                    // Scroll the sidebar to show the selected restaurant
                    const sidebarContainer = document.querySelector('.sidebar-restaurants');
                    if (sidebarContainer) {
                        clickedItem.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest' 
                        });
                    }
                }
            }

            zoomToRestaurant(restaurant) {
                if (this.map && restaurant.latitude && restaurant.longitude) {
                    // Zoom to restaurant location
                    this.map.setView([restaurant.latitude, restaurant.longitude], 16);
                    
                    // Find and open the popup for this restaurant
                    const marker = this.mapMarkers.find(m => 
                        m.restaurantData && m.restaurantData.id === restaurant.id
                    );
                    
                    if (marker) {
                        marker.openPopup();
                    }
                }
            }

            // Happy Hour functionality
            initializeHappyHour() {
                this.updateCurrentTime();
                this.startTimeUpdates();
                this.loadHappyHours();
            }

            startTimeUpdates() {
                // Update time every minute
                this.timeUpdateInterval = setInterval(() => {
                    this.updateCurrentTime();
                    this.loadHappyHours(); // Refresh to update "happening now" status
                }, 60000);
            }

            updateCurrentTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    timeZone: 'America/New_York'
                };
                const timeString = now.toLocaleDateString('en-US', options);
                
                const currentTimeEl = document.getElementById('current-time');
                if (currentTimeEl) {
                    currentTimeEl.textContent = `${timeString} (NYC Time)`;
                }
            }

            parseHappyHour(happyHourText) {
                if (!happyHourText) return null;

                const text = happyHourText.toLowerCase();
                const days = [];
                const times = [];
                let hasFood = false;
                let hasDrinks = false;

                // Parse days
                const dayMap = {
                    'monday': 'monday', 'mon': 'monday',
                    'tuesday': 'tuesday', 'tue': 'tuesday', 'tues': 'tuesday',
                    'wednesday': 'wednesday', 'wed': 'wednesday',
                    'thursday': 'thursday', 'thu': 'thursday', 'thur': 'thursday', 'thurs': 'thursday',
                    'friday': 'friday', 'fri': 'friday',
                    'saturday': 'saturday', 'sat': 'saturday',
                    'sunday': 'sunday', 'sun': 'sunday'
                };

                // Check for day ranges
                if (text.includes('weekday') || text.includes('mon-fri') || text.includes('monday-friday')) {
                    days.push('weekday');
                } else if (text.includes('weekend') || text.includes('sat-sun') || text.includes('saturday-sunday')) {
                    days.push('weekend');
                } else if (text.includes('daily') || text.includes('every day')) {
                    days.push('monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday');
                } else {
                    // Parse individual days
                    Object.keys(dayMap).forEach(key => {
                        if (text.includes(key)) {
                            if (!days.includes(dayMap[key])) {
                                days.push(dayMap[key]);
                            }
                        }
                    });
                }

                // Parse times (simple regex for common formats)
                const timeRegex = /(\d{1,2}):?(\d{2})?\s*(am|pm)?\s*-\s*(\d{1,2}):?(\d{2})?\s*(am|pm)/gi;
                const timeMatches = text.match(timeRegex);
                if (timeMatches) {
                    times.push(...timeMatches);
                }

                // Check for food/drink keywords
                const foodKeywords = ['food', 'appetizer', 'apps', 'small plates', 'bites', 'eats', 'pizza', 'tacos'];
                const drinkKeywords = ['drinks', 'cocktail', 'beer', 'wine', 'spirits', 'shots', 'happy hour'];
                
                hasFood = foodKeywords.some(keyword => text.includes(keyword));
                hasDrinks = drinkKeywords.some(keyword => text.includes(keyword)) || !hasFood; // assume drinks if no food mentioned

                return {
                    days: days.length > 0 ? days : ['unknown'],
                    times: times,
                    hasFood,
                    hasDrinks,
                    originalText: happyHourText
                };
            }

            async loadHappyHours() {
                try {
                    console.log('Starting loadHappyHours...');
                    
                    // Get all restaurants with happy hours
                    const response = await fetch('/api/restaurants?limit=1000');
                    console.log('API response status:', response.status);
                    
                    const allRestaurants = await response.json();
                    console.log('Total restaurants loaded:', allRestaurants.length);
                    
                    // Filter restaurants that have the happy hour checkbox checked
                    const restaurantsWithHH = allRestaurants.filter(r => 
                        r.has_happy_hour || 
                        r.happy_hour_data || 
                        (r.happy_hour && r.happy_hour.trim()) ||
                        (r.happy_hour_days && r.happy_hour_days !== 'null')
                    );
                    console.log('Restaurants with happy hour:', restaurantsWithHH.length);
                    console.log('HH restaurants:', restaurantsWithHH.map(r => r.name));

                    // Apply filters
                    console.log('Applying filters...');
                    const filteredRestaurants = this.filterHappyHours(restaurantsWithHH);
                    console.log('Filtered restaurants:', filteredRestaurants.length);
                    
                    console.log('Rendering...');
                    this.renderHappyHours(filteredRestaurants);
                    this.updateHappyHourCounts(filteredRestaurants);
                    
                    // Store filtered restaurants for timeline view
                    this.currentHappyHourRestaurants = filteredRestaurants;
                    
                    console.log('Done!');

                } catch (error) {
                    console.error('Error loading happy hours:', error);
                    console.error('Stack trace:', error.stack);
                    document.getElementById('happy-hour-list').innerHTML = '<div class="error">Error loading happy hours: ' + error.message + '</div>';
                }
            }

            filterHappyHours(restaurants) {
                return restaurants.filter(restaurant => {
                    // First check: Restaurant must have happy hour data
                    const hasHappyHourData = restaurant.happy_hour_data || 
                                           restaurant.happy_hour || 
                                           (restaurant.happy_hour_days && restaurant.happy_hour_days !== 'null');
                    
                    
                    if (!hasHappyHourData) {
                        return false;
                    }
                    
                    // For now, we'll work with the existing happy hour parsing until you update the database
                    // This is a transitional approach that will work with both old and new data structures
                    
                    // Days filter (multiple selection)
                    if (this.happyHourFilters.days && this.happyHourFilters.days.length > 0) {
                        let hasMatchingDay = false;
                        
                        // Check if restaurant has any of the selected days
                        // This could be in happy_hour_days array (new structure) or parsed from text (old structure)
                        if (restaurant.happy_hour_days) {
                            // New structure: parse JSON and check if any selected day is in the restaurant's happy_hour_days
                            try {
                                const days = JSON.parse(restaurant.happy_hour_days);
                                if (Array.isArray(days)) {
                                    hasMatchingDay = this.happyHourFilters.days.some(day => 
                                        days.includes(day)
                                    );
                                }
                            } catch (e) {
                                // If JSON parsing fails, fall back to old structure
                                if (restaurant.happy_hour) {
                                    const parsed = this.parseHappyHour(restaurant.happy_hour);
                                    if (parsed && parsed.days) {
                                        hasMatchingDay = this.happyHourFilters.days.some(day => 
                                            parsed.days.includes(day)
                                        );
                                    }
                                }
                            }
                        } else if (restaurant.happy_hour) {
                            // Old structure: parse the text and check
                            const parsed = this.parseHappyHour(restaurant.happy_hour);
                            if (parsed && parsed.days) {
                                hasMatchingDay = this.happyHourFilters.days.some(day => 
                                    parsed.days.includes(day)
                                );
                            }
                        }
                        
                        if (!hasMatchingDay) {
                            return false;
                        }
                    }

                    // Neighborhood filter
                    if (this.happyHourFilters.neighborhood && 
                        (!restaurant.neighborhoods || !restaurant.neighborhoods.includes(this.happyHourFilters.neighborhood))) {
                        return false;
                    }

                    // Has food filter
                    if (this.happyHourFilters.hasFood) {
                        if (this.happyHourFilters.hasFood === 'yes') {
                            // Check if restaurant has food during happy hour
                            if (restaurant.happy_hour_has_food === false) {
                                return false;
                            }
                            // Fall back to parsing text for old structure
                            if (restaurant.happy_hour_has_food === undefined && restaurant.happy_hour) {
                                const parsed = this.parseHappyHour(restaurant.happy_hour);
                                if (parsed && !parsed.hasFood) {
                                    return false;
                                }
                            }
                        } else if (this.happyHourFilters.hasFood === 'no') {
                            // Drinks only
                            if (restaurant.happy_hour_has_food === true) {
                                return false;
                            }
                            // Fall back to parsing text for old structure
                            if (restaurant.happy_hour_has_food === undefined && restaurant.happy_hour) {
                                const parsed = this.parseHappyHour(restaurant.happy_hour);
                                if (parsed && parsed.hasFood) {
                                    return false;
                                }
                            }
                        }
                    }

                    return true;
                });
            }

            renderHappyHours(restaurants) {
                const happyHourList = document.getElementById('happy-hour-list');
                
                if (restaurants.length === 0) {
                    happyHourList.innerHTML = '<div class="no-results">No happy hours found with current filters</div>';
                    return;
                }

                happyHourList.innerHTML = '';
                
                restaurants.forEach(restaurant => {
                    const hhElement = this.createHappyHourElement(restaurant);
                    happyHourList.appendChild(hhElement);
                });
            }

            createHappyHourElement(restaurant) {
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                
                // Get days from either JSON data or parsed data
                let allDays = [];
                
                // Try JSON format first
                if (restaurant.happy_hour_data) {
                    try {
                        const happyHourData = typeof restaurant.happy_hour_data === 'string' 
                            ? JSON.parse(restaurant.happy_hour_data) 
                            : restaurant.happy_hour_data;
                        
                        if (happyHourData && happyHourData.schedules) {
                            allDays = happyHourData.schedules.flatMap(schedule => 
                                schedule.days || []
                            );
                        }
                    } catch (e) {
                        console.warn('Error parsing happy hour data for', restaurant.name, e);
                    }
                }
                
                // Fallback to parsed data
                if (allDays.length === 0 && restaurant.happyHourParsed && restaurant.happyHourParsed.days) {
                    allDays = restaurant.happyHourParsed.days;
                }
                
                // Determine status
                let status = 'other';
                let statusText = 'Available';
                
                if (allDays.includes(today) || 
                    (allDays.includes('weekday') && ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].includes(today)) ||
                    (allDays.includes('weekend') && ['saturday', 'sunday'].includes(today))) {
                    status = 'today';
                    statusText = 'Today ✨';
                }

                const likedIcon = restaurant.liked ? '❤️' : '♡';
                
                const element = document.createElement('div');
                element.className = 'happy-hour-item';
                element.setAttribute('data-restaurant-id', restaurant.id);
                
                element.innerHTML = `
                    <div class="hh-restaurant-line" onclick="toggleHappyHourDetails(${restaurant.id})">
                        <div class="hh-restaurant-name">
                            ${restaurant.name}
                            <span class="inline-actions">
                                <span class="action-emoji ${restaurant.liked ? 'liked' : ''}" 
                                      onclick="event.stopPropagation(); toggleLiked(${restaurant.id}, ${!restaurant.liked})" 
                                      title="Toggle liked status">
                                    ${likedIcon}
                                </span>
                                <span class="action-emoji edit-emoji" 
                                      onclick="event.stopPropagation(); window.restaurantEditor.openEditModal(${restaurant.id})" 
                                      title="Edit restaurant">
                                    ⚪
                                </span>
                            </span>
                        </div>
                        <div class="hh-restaurant-borough ${restaurant.borough ? 'clickable-filter' : ''}" 
                             ${restaurant.borough ? `onclick="event.stopPropagation(); filterByBorough('${restaurant.borough}')" title="Filter by ${restaurant.borough}"` : ''}>
                            ${restaurant.borough || '-'}
                        </div>
                        <div class="hh-restaurant-neighborhood">
                            ${restaurant.neighborhoods && restaurant.neighborhoods.length ? 
                                restaurant.neighborhoods.map(neighborhood => 
                                    `<span class="neighborhood-item" onclick="event.stopPropagation(); filterByNeighborhood('${neighborhood}')" title="Filter by ${neighborhood}">${neighborhood}</span>`
                                ).join('') : '-'
                            }
                        </div>
                        <div class="hh-restaurant-time">
                            ${this.renderHappyHourSchedules(restaurant)}
                        </div>
                    </div>
                    
                    <div class="hh-restaurant-details" id="hh-details-${restaurant.id}" style="display: none;">
                        <div class="details-condensed">
                            ${restaurant.borough ? `<div class="detail-row"><strong>Borough:</strong> ${restaurant.borough}</div>` : ''}
                            ${restaurant.neighborhoods && restaurant.neighborhoods.length ? `<div class="detail-row"><strong>Neighborhood:</strong> ${restaurant.neighborhoods.join(', ')}</div>` : ''}
                            ${restaurant.address ? `<div class="detail-row"><strong>Address:</strong> ${restaurant.address}</div>` : ''}
                            ${restaurant.cuisines && restaurant.cuisines.length ? `<div class="detail-row"><strong>Cuisine:</strong> ${restaurant.cuisines.join(', ')}</div>` : ''}
                            ${restaurant.types && restaurant.types.length ? `<div class="detail-row"><strong>Type:</strong> ${restaurant.types.join(', ')}</div>` : ''}
                            ${restaurant.tags && restaurant.tags.length ? `<div class="detail-row"><strong>Tags:</strong> ${restaurant.tags.map(tag => tag.name).join(', ')}</div>` : ''}
                            <div class="detail-row"><strong>Happy Hour Days:</strong> 
                                <div class="day-tags-inline">
                                    ${allDays.map(day => 
                                        `<span class="day-tag ${day === today ? 'active-today' : ''}">${this.capitalizeDayName(day)}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <div class="detail-row"><strong>Schedule:</strong> ${this.renderHappyHourSchedules(restaurant)}</div>
                            ${restaurant.website_link ? `<div class="detail-row"><strong>Website:</strong> <a href="${restaurant.website_link}" target="_blank">${restaurant.website_link}</a></div>` : ''}
                            ${restaurant.what_to_order ? `<div class="detail-row"><strong>What to Order:</strong> ${restaurant.what_to_order}</div>` : ''}
                            ${restaurant.notes ? `<div class="detail-row"><strong>Notes:</strong> ${restaurant.notes}</div>` : ''}
                        </div>
                        
                        <div class="details-actions">
                            <button onclick="event.stopPropagation(); toggleLiked(${restaurant.id}, ${!restaurant.liked})" 
                                    class="action-btn">
                                ${restaurant.liked ? '❤️ Unlike' : '♡ Like'}
                            </button>
                            <button onclick="event.stopPropagation(); toggleStatus(${restaurant.id})" 
                                    class="action-btn">
                                ${restaurant.status === 'Visited' ? '✅ Mark Unvisited' : '📍 Mark Visited'}
                            </button>
                            <button onclick="event.stopPropagation(); window.restaurantEditor.openEditModal(${restaurant.id})" 
                                    class="action-btn">
                                ✏️ Edit
                            </button>
                        </div>
                    </div>
                `;
                
                return element;
            }
            
            renderHappyHourSchedules(restaurant) {
                // Parse JSON happy hour data
                let happyHourData = null;
                if (restaurant.happy_hour_data) {
                    try {
                        happyHourData = typeof restaurant.happy_hour_data === 'string' 
                            ? JSON.parse(restaurant.happy_hour_data) 
                            : restaurant.happy_hour_data;
                    } catch (e) {
                        console.error('Error parsing happy hour data:', e);
                    }
                }
                
                // If we have JSON data, render it richly
                if (happyHourData && happyHourData.schedules && happyHourData.schedules.length > 0) {
                    // Consolidate schedules with same times
                    const consolidatedSchedules = this.consolidateSchedules(happyHourData.schedules);
                    
                    return consolidatedSchedules.map(schedule => {
                        // Safety checks for schedule structure
                        if (!schedule.days || !Array.isArray(schedule.days)) {
                            console.warn('Invalid schedule data for restaurant:', restaurant.name, schedule);
                            return '<div class="hh-times-fallback">Schedule data needs update</div>';
                        }
                        
                        const times = schedule.startTime && schedule.endTime 
                            ? `${this.formatTime(schedule.startTime)} - ${this.formatTime(schedule.endTime)}`
                            : '';
                        
                        const daysDisplay = this.formatDaysDisplay(schedule.days);
                        
                        return `
                            <div class="hh-schedule-block">
                                <div class="hh-days">
                                    ${daysDisplay}
                                </div>
                                ${times ? `<div class="hh-times-primary">${times}</div>` : ''}
                                ${schedule.offers && this.hasOffers(schedule.offers) ? 
                                    `<div class="hh-offers">
                                        ${this.formatOffers(schedule.offers)}
                                    </div>` : ''
                                }
                            </div>
                        `;
                    }).join('');
                }
                
                // Fallback to old parsing or simple display
                const hh = restaurant.happyHourParsed;
                if (!hh) {
                    // Simple fallback for restaurants with checkbox but no detailed data
                    return '<div class="hh-times-fallback">Happy hour available - details coming soon</div>';
                }
                
                return `
                    <div class="hh-time-info">
                        <div class="hh-days">
                            ${hh.days.map(day => 
                                `<span class="day-tag ${day === 'unknown' ? 'unknown' : ''}" 
                                       onclick="event.stopPropagation(); filterByDay('${day}')" 
                                       title="Filter by ${day}">
                                    ${this.capitalizeDayName(day)}
                                </span>`
                            ).join('')}
                        </div>
                        ${restaurant.happy_hour_start_time && restaurant.happy_hour_end_time ? 
                            `<div class="hh-times-primary">${this.formatTime(restaurant.happy_hour_start_time)} - ${this.formatTime(restaurant.happy_hour_end_time)}</div>` :
                            hh.times && hh.times.length > 0 ? `<div class="hh-times-primary">${hh.times.join(', ')}</div>` : 
                            `<div class="hh-times-fallback">${hh.originalText}</div>`
                        }
                    </div>
                `;
            }

            capitalizeDayName(day) {
                if (day === 'weekday') return 'Weekdays';
                if (day === 'weekend') return 'Weekends';
                return day.charAt(0).toUpperCase() + day.slice(1);
            }
            
            formatTime(timeString) {
                if (!timeString) return '';
                
                // Convert 24-hour format to 12-hour format
                const [hours, minutes] = timeString.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                
                return `${displayHour}:${minutes} ${ampm}`;
            }

            consolidateSchedules(schedules) {
                // Group schedules by time
                const timeGroups = {};
                
                schedules.forEach(schedule => {
                    const timeKey = `${schedule.startTime || ''}-${schedule.endTime || ''}`;
                    if (!timeGroups[timeKey]) {
                        timeGroups[timeKey] = {
                            ...schedule,
                            days: []
                        };
                    }
                    timeGroups[timeKey].days.push(...schedule.days);
                });
                
                // Convert back to array and remove duplicates in days
                return Object.values(timeGroups).map(group => ({
                    ...group,
                    days: [...new Set(group.days)]
                }));
            }

            formatDaysDisplay(days) {
                // Define weekdays and weekends
                const weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                const weekends = ['saturday', 'sunday'];
                
                // Check if all weekdays are present
                const hasAllWeekdays = weekdays.every(day => days.includes(day));
                const hasAllWeekends = weekends.every(day => days.includes(day));
                
                // If all 7 days, show "Daily"
                if (hasAllWeekdays && hasAllWeekends) {
                    return '<span class="day-tag-consolidated">Daily</span>';
                }
                
                // If all weekdays but not weekends
                if (hasAllWeekdays && !hasAllWeekends) {
                    const extraWeekendDays = days.filter(day => weekends.includes(day));
                    if (extraWeekendDays.length === 0) {
                        return '<span class="day-tag-consolidated">Weekdays</span>';
                    } else {
                        return `<span class="day-tag-consolidated">Weekdays</span> + ${extraWeekendDays.map(day => 
                            `<span class="day-tag" onclick="event.stopPropagation(); filterByDay('${day}')" title="Filter by ${day}">
                                ${this.capitalizeDayName(day)}
                            </span>`
                        ).join('')}`;
                    }
                }
                
                // If all weekends but not weekdays
                if (hasAllWeekends && !hasAllWeekdays) {
                    const extraWeekdays = days.filter(day => weekdays.includes(day));
                    if (extraWeekdays.length === 0) {
                        return '<span class="day-tag-consolidated">Weekends</span>';
                    } else {
                        return `<span class="day-tag-consolidated">Weekends</span> + ${extraWeekdays.map(day => 
                            `<span class="day-tag" onclick="event.stopPropagation(); filterByDay('${day}')" title="Filter by ${day}">
                                ${this.capitalizeDayName(day)}
                            </span>`
                        ).join('')}`;
                    }
                }
                
                // Otherwise, show individual days
                return days.map(day => 
                    `<span class="day-tag" onclick="event.stopPropagation(); filterByDay('${day}')" title="Filter by ${day}">
                        ${this.capitalizeDayName(day)}
                    </span>`
                ).join('');
            }


            updateHappyHourCounts(restaurants) {
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                const todayCount = restaurants.filter(r => {
                    const hh = r.happyHourParsed;
                    return hh && (hh.days.includes(today) || 
                           (hh.days.includes('weekday') && ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].includes(today)) ||
                           (hh.days.includes('weekend') && ['saturday', 'sunday'].includes(today)));
                }).length;

                const happeningNowEl = document.getElementById('happening-now-count');
                if (happeningNowEl) {
                    happeningNowEl.textContent = `${todayCount} Today`;
                }

                const resultsCountEl = document.getElementById('happy-hour-results-count');
                if (resultsCountEl) {
                    resultsCountEl.textContent = `${restaurants.length} restaurant${restaurants.length !== 1 ? 's' : ''} with happy hour`;
                }
            }

            hasOffers(offers) {
                if (!offers) return false;
                
                // Check new format (specials)
                if (offers.specials && offers.specials.length > 0) return true;
                
                // Check legacy format (drinks + food)
                if ((offers.drinks && offers.drinks.length > 0) || 
                    (offers.food && offers.food.length > 0)) return true;
                
                return false;
            }

            formatOffers(offers) {
                if (!offers) return '';
                
                // Use new format if available
                if (offers.specials && offers.specials.length > 0) {
                    return `<span class="offer-type">○ ${offers.specials.slice(0, 3).join(', ')}${offers.specials.length > 3 ? '...' : ''}</span>`;
                }
                
                // Fall back to legacy format
                const parts = [];
                if (offers.drinks && offers.drinks.length > 0) {
                    parts.push(`<span class="offer-type">○ ${offers.drinks.slice(0, 2).join(', ')}${offers.drinks.length > 2 ? '...' : ''}</span>`);
                }
                if (offers.food && offers.food.length > 0) {
                    parts.push(`<span class="offer-type">□ ${offers.food.slice(0, 2).join(', ')}${offers.food.length > 2 ? '...' : ''}</span>`);
                }
                
                return parts.join(' ');
            }

            // Timeline View Functions
            generateTimeline() {
                if (!this.currentHappyHourRestaurants) return;
                
                const now = new Date();
                const today = now.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                
                console.log('Current time debug:', {
                    fullDate: now.toString(),
                    localTime: now.toLocaleTimeString(),
                    hour: currentHour,
                    minutes: currentMinutes,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                });
                
                // Set timeline to start 1 hour before current time, but ensure current time is always included
                let timelineStart = currentHour - 1;
                
                // Handle edge cases
                if (timelineStart < 12) timelineStart = 12; // Start no earlier than noon
                if (currentHour < 15) timelineStart = Math.min(timelineStart, 12); // For early times, can start at noon
                
                const timelineEnd = timelineStart + 7; // 7 hour window
                
                console.log('Timeline bounds:', timelineStart, 'to', timelineEnd, 'Current hour:', currentHour);
                
                // Generate dynamic hour headers
                this.generateTimelineHeaders(timelineStart, timelineEnd);
                
                // Filter restaurants that have happy hour today
                const todaysRestaurants = this.currentHappyHourRestaurants.filter(restaurant => {
                    return this.isRestaurantActiveToday(restaurant, today);
                });
                
                const timelineContent = document.getElementById('timeline-content');
                timelineContent.innerHTML = '';
                
                if (todaysRestaurants.length === 0) {
                    timelineContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">No happy hours available today</div>';
                    return;
                }
                
                // Create timeline container for current time line
                const timelineContainer = document.getElementById('timeline-container');
                
                // Remove any existing current time line
                const existingLine = timelineContainer.querySelector('.current-time-line');
                if (existingLine) {
                    existingLine.remove();
                }
                
                todaysRestaurants.forEach(restaurant => {
                    const schedules = this.getRestaurantSchedulesToday(restaurant, today);
                    if (schedules.length > 0) {
                        const row = this.createTimelineRow(restaurant, schedules, currentHour, timelineStart, timelineEnd);
                        timelineContent.appendChild(row);
                    }
                });
                
                // Add current time indicator line
                this.addCurrentTimeLine(currentHour, currentMinutes, timelineStart, timelineEnd);
                
                
                // Setup resize listener for current time line
                this.setupTimelineResize(currentHour, currentMinutes, timelineStart, timelineEnd);
            }
            
            generateTimelineHeaders(startHour, endHour) {
                const headerContainer = document.getElementById('timeline-header');
                headerContainer.innerHTML = '';
                
                for (let hour = startHour; hour < endHour; hour++) {
                    const hourDiv = document.createElement('div');
                    hourDiv.className = 'timeline-hour';
                    
                    // Format hour display
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const timeText = `${displayHour} ${ampm}`;
                    hourDiv.textContent = timeText;
                    
                    console.log(`Hour ${hour} -> Display: ${timeText}`);
                    
                    headerContainer.appendChild(hourDiv);
                }
            }
            
            addCurrentTimeLine(currentHour, currentMinutes, timelineStart, timelineEnd) {
                console.log('Adding time line. Current:', currentHour + ':' + currentMinutes, 'Timeline:', timelineStart, 'to', timelineEnd);
                
                // Only show line if current time is within the timeline
                if (currentHour < timelineStart || currentHour >= timelineEnd) {
                    console.log('Current time outside timeline bounds');
                    return;
                }
                
                // Wait for DOM to be ready
                setTimeout(() => {
                    const timelineContainer = document.getElementById('timeline-container');
                    if (!timelineContainer) return;
                    
                    const totalMinutes = (timelineEnd - timelineStart) * 60;
                    const currentTotalMinutes = (currentHour - timelineStart) * 60 + currentMinutes;
                    const currentOffset = (currentTotalMinutes / totalMinutes) * 100;
                    
                    console.log('Current offset percentage:', currentOffset);
                    
                    // Calculate actual pixel position (timeline now spans full width)
                    const containerWidth = timelineContainer.offsetWidth;
                    const linePosition = (containerWidth * currentOffset / 100);
                    
                    console.log('Container width:', containerWidth, 'Line position:', linePosition);
                    
                    const currentTimeLine = document.createElement('div');
                    currentTimeLine.className = 'current-time-line';
                    currentTimeLine.style.left = `${linePosition}px`;
                    
                    timelineContainer.appendChild(currentTimeLine);
                }, 100);
            }
            
            setupTimelineResize(currentHour, currentMinutes, timelineStart, timelineEnd) {
                // Remove existing resize listener if any
                if (this.resizeListener) {
                    window.removeEventListener('resize', this.resizeListener);
                }
                
                this.resizeListener = () => {
                    // Debounce resize events
                    clearTimeout(this.resizeTimeout);
                    this.resizeTimeout = setTimeout(() => {
                        // Remove existing time line and recreate it
                        const timelineContainer = document.getElementById('timeline-container');
                        if (timelineContainer) {
                            const existingLine = timelineContainer.querySelector('.current-time-line');
                            if (existingLine) {
                                existingLine.remove();
                            }
                            this.addCurrentTimeLine(currentHour, currentMinutes, timelineStart, timelineEnd);
                        }
                    }, 100);
                };
                
                window.addEventListener('resize', this.resizeListener);
            }
            
            isRestaurantActiveToday(restaurant, today) {
                // Check JSON format
                if (restaurant.happy_hour_data) {
                    try {
                        const data = typeof restaurant.happy_hour_data === 'string' 
                            ? JSON.parse(restaurant.happy_hour_data) 
                            : restaurant.happy_hour_data;
                        
                        if (data && data.schedules) {
                            return data.schedules.some(schedule => 
                                schedule.days && schedule.days.includes(today)
                            );
                        }
                    } catch (e) {
                        console.error('Error parsing happy hour data:', e);
                    }
                }
                
                // Check parsed format
                const hh = restaurant.happyHourParsed;
                if (hh && hh.days) {
                    return hh.days.includes(today) || 
                           (hh.days.includes('weekday') && ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].includes(today)) ||
                           (hh.days.includes('weekend') && ['saturday', 'sunday'].includes(today));
                }
                
                return false;
            }
            
            getRestaurantSchedulesToday(restaurant, today) {
                const schedules = [];
                
                // Check JSON format
                if (restaurant.happy_hour_data) {
                    try {
                        const data = typeof restaurant.happy_hour_data === 'string' 
                            ? JSON.parse(restaurant.happy_hour_data) 
                            : restaurant.happy_hour_data;
                        
                        if (data && data.schedules) {
                            data.schedules.forEach(schedule => {
                                if (schedule.days && schedule.days.includes(today) && schedule.startTime && schedule.endTime) {
                                    schedules.push({
                                        startTime: schedule.startTime,
                                        endTime: schedule.endTime,
                                        offers: schedule.offers
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing happy hour data:', e);
                    }
                }
                
                // Fallback to legacy format
                if (schedules.length === 0 && restaurant.happy_hour_start_time && restaurant.happy_hour_end_time) {
                    schedules.push({
                        startTime: restaurant.happy_hour_start_time,
                        endTime: restaurant.happy_hour_end_time
                    });
                }
                
                return schedules;
            }
            
            createTimelineRow(restaurant, schedules, currentHour, timelineStart, timelineEnd) {
                const row = document.createElement('div');
                row.className = 'timeline-row';
                
                const scheduleContainer = document.createElement('div');
                scheduleContainer.className = 'timeline-schedule';
                
                // Create background slots for grid structure
                for (let hour = timelineStart; hour < timelineEnd; hour++) {
                    const slot = document.createElement('div');
                    slot.className = 'timeline-slot';
                    scheduleContainer.appendChild(slot);
                }
                
                // Create bars for each schedule
                schedules.forEach(schedule => {
                    const startHour = parseInt(schedule.startTime.split(':')[0]);
                    const endHour = parseInt(schedule.endTime.split(':')[0]);
                    const startMinutes = parseInt(schedule.startTime.split(':')[1] || 0);
                    const endMinutes = parseInt(schedule.endTime.split(':')[1] || 0);
                    
                    // Clamp the schedule to timeline bounds
                    const clampedStartHour = Math.max(startHour, timelineStart);
                    const clampedEndHour = Math.min(endHour, timelineEnd);
                    const clampedStartMinutes = startHour >= timelineStart ? startMinutes : 0;
                    const clampedEndMinutes = endHour <= timelineEnd ? endMinutes : 0;
                    
                    // Skip if the schedule is completely outside our timeline
                    if (clampedStartHour >= clampedEndHour) {
                        return;
                    }
                    
                    // Calculate position and width as percentages within the timeline
                    const totalMinutes = (timelineEnd - timelineStart) * 60; // 7 hours
                    const startOffset = ((clampedStartHour - timelineStart) * 60 + clampedStartMinutes) / totalMinutes * 100;
                    const duration = ((clampedEndHour - clampedStartHour) * 60 + (clampedEndMinutes - clampedStartMinutes)) / totalMinutes * 100;
                    
                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar';
                    
                    // Check if this schedule is currently active
                    const isCurrentlyActive = currentHour >= startHour && currentHour < endHour;
                    if (isCurrentlyActive) {
                        bar.classList.add('current');
                    }
                    
                    // Position the bar within the timeline bounds
                    bar.style.left = `${Math.max(0, startOffset)}%`;
                    bar.style.width = `${Math.min(100 - Math.max(0, startOffset), duration)}%`;
                    
                    // Add click handler
                    bar.addEventListener('click', () => {
                        openRestaurantDetails(restaurant.id);
                    });
                    
                    // Add tooltip
                    const startTime = this.formatTime(schedule.startTime);
                    const endTime = this.formatTime(schedule.endTime);
                    let tooltip = `${restaurant.name}\n${startTime} - ${endTime}`;
                    
                    if (schedule.offers) {
                        const offers = this.formatOffersText(schedule.offers);
                        if (offers) {
                            tooltip += `\n${offers}`;
                        }
                    }
                    
                    bar.title = tooltip;
                    
                    // Add restaurant name and location to the bar
                    bar.innerHTML = `
                        <div class="timeline-bar-name">${restaurant.name}</div>
                        <div class="timeline-bar-location">${restaurant.borough || ''} ${restaurant.neighborhoods && restaurant.neighborhoods.length ? '• ' + restaurant.neighborhoods[0] : ''}</div>
                        <div class="timeline-bar-time">${startTime} - ${endTime}</div>
                    `;
                    
                    // Add click handler to bar
                    bar.addEventListener('click', () => {
                        openRestaurantDetails(restaurant.id);
                    });
                    
                    scheduleContainer.appendChild(bar);
                });
                
                row.appendChild(scheduleContainer);
                
                return row;
            }
            
            formatOffersText(offers) {
                if (!offers) return '';
                
                if (offers.specials && offers.specials.length > 0) {
                    return offers.specials[0].substring(0, 15) + (offers.specials[0].length > 15 ? '...' : '');
                }
                
                if (offers.drinks && offers.drinks.length > 0) {
                    return offers.drinks[0].substring(0, 15) + (offers.drinks[0].length > 15 ? '...' : '');
                }
                
                if (offers.food && offers.food.length > 0) {
                    return offers.food[0].substring(0, 15) + (offers.food[0].length > 15 ? '...' : '');
                }
                
                return '';
            }

            parseFloat(value) {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? null : parsed;
            }

            parseCommaSeparated(value) {
                if (!value || !value.trim()) return [];
                return value.split(',').map(item => item.trim()).filter(item => item);
            }

            showMessage(message, type = 'info') {
                let messageArea = document.getElementById('message-area');
                if (!messageArea) {
                    messageArea = document.createElement('div');
                    messageArea.id = 'message-area';
                    document.body.appendChild(messageArea);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${type}`;
                messageDiv.textContent = message;
                
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 0;
                    color: white;
                    font-weight: 500;
                    z-index: 1001;
                    max-width: 400px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;

                if (type === 'success') {
                    messageDiv.style.backgroundColor = '#10b981';
                } else if (type === 'error') {
                    messageDiv.style.backgroundColor = '#ef4444';
                } else {
                    messageDiv.style.backgroundColor = 'var(--accent-color)';
                }

                messageArea.appendChild(messageDiv);

                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 4000);
            }

            async geocodeAddress(isEdit = false) {
                const addressInput = document.getElementById(isEdit ? 'edit-address-input' : 'address-input');
                const latitudeInput = document.getElementById(isEdit ? 'edit-latitude' : 'latitude');
                const longitudeInput = document.getElementById(isEdit ? 'edit-longitude' : 'longitude');
                const statusDiv = document.getElementById(isEdit ? 'edit-location-status' : 'location-status');
                
                const address = addressInput.value.trim();
                if (!address) {
                    this.showLocationStatus('Please enter an address or restaurant name', 'error', statusDiv);
                    return;
                }

                this.showLocationStatus('🔍 Searching for location...', 'info', statusDiv);

                try {
                    // Use Nominatim (free OpenStreetMap geocoding)
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', New York City, NY')}&limit=1&addressdetails=1`);
                    const results = await response.json();

                    if (results && results.length > 0) {
                        const result = results[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);

                        latitudeInput.value = lat;
                        longitudeInput.value = lng;

                        this.showLocationStatus(`✅ Found: ${result.display_name}`, 'success', statusDiv);
                        
                        // Clear the address input since we got the coordinates
                        addressInput.value = '';
                    } else {
                        this.showLocationStatus('❌ Location not found. Try being more specific or use manual coordinates.', 'error', statusDiv);
                    }
                } catch (error) {
                    console.error('Geocoding error:', error);
                    this.showLocationStatus('❌ Error searching for location. Please try manual coordinates.', 'error', statusDiv);
                }
            }

            parseGoogleMapsLink(isEdit = false) {
                const linkInput = document.getElementById(isEdit ? 'edit-maps-link-input' : 'maps-link-input');
                const latitudeInput = document.getElementById(isEdit ? 'edit-latitude' : 'latitude');
                const longitudeInput = document.getElementById(isEdit ? 'edit-longitude' : 'longitude');
                const statusDiv = document.getElementById(isEdit ? 'edit-location-status' : 'location-status');
                
                const link = linkInput.value.trim();
                if (!link) {
                    this.showLocationStatus('Please paste a Google Maps link', 'error', statusDiv);
                    return;
                }

                try {
                    let lat, lng;

                    // Try different Google Maps URL formats
                    // Format 1: @lat,lng,zoom
                    let match = link.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                    if (match) {
                        lat = parseFloat(match[1]);
                        lng = parseFloat(match[2]);
                    } else {
                        // Format 2: !3d lat !4d lng
                        const latMatch = link.match(/!3d(-?\d+\.?\d*)/);
                        const lngMatch = link.match(/!4d(-?\d+\.?\d*)/);
                        if (latMatch && lngMatch) {
                            lat = parseFloat(latMatch[1]);
                            lng = parseFloat(lngMatch[1]);
                        } else {
                            // Format 3: q=lat,lng
                            match = link.match(/q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                            if (match) {
                                lat = parseFloat(match[1]);
                                lng = parseFloat(match[2]);
                            }
                        }
                    }

                    if (lat && lng) {
                        latitudeInput.value = lat;
                        longitudeInput.value = lng;
                        this.showLocationStatus(`✅ Coordinates extracted: ${lat}, ${lng}`, 'success', statusDiv);
                        
                        // Clear the link input
                        linkInput.value = '';
                    } else {
                        this.showLocationStatus('❌ Could not extract coordinates from this link. Please try a different Google Maps link.', 'error', statusDiv);
                    }
                } catch (error) {
                    console.error('Link parsing error:', error);
                    this.showLocationStatus('❌ Error parsing Google Maps link.', 'error', statusDiv);
                }
            }

            showLocationStatus(message, type, statusDiv) {
                if (!statusDiv) return;
                
                statusDiv.style.display = 'block';
                statusDiv.textContent = message;
                
                // Style based on type
                if (type === 'success') {
                    statusDiv.style.backgroundColor = '#d1fae5';
                    statusDiv.style.color = '#065f46';
                    statusDiv.style.border = '1px solid #a7f3d0';
                } else if (type === 'error') {
                    statusDiv.style.backgroundColor = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.style.border = '1px solid #fca5a5';
                } else {
                    statusDiv.style.backgroundColor = '#dbeafe';
                    statusDiv.style.color = '#1e40af';
                    statusDiv.style.border = '1px solid #93c5fd';
                }

                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Restaurant Editor Class
        class RestaurantEditor {
            constructor() {
                this.currentRestaurantId = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('close-edit-modal')?.addEventListener('click', () => this.closeEditModal());
                document.getElementById('cancel-edit')?.addEventListener('click', () => this.closeEditModal());
                document.querySelector('.modal-overlay')?.addEventListener('click', () => this.closeEditModal());
                document.getElementById('edit-restaurant-form')?.addEventListener('submit', (e) => this.handleEditSubmit(e));
                document.getElementById('delete-restaurant')?.addEventListener('click', () => this.handleDelete());
                
                // Location helper buttons for edit modal
                document.getElementById('edit-geocode-btn')?.addEventListener('click', () => {
                    if (window.restaurantApp) {
                        window.restaurantApp.geocodeAddress(true);
                    }
                });
                document.getElementById('edit-parse-link-btn')?.addEventListener('click', () => {
                    if (window.restaurantApp) {
                        window.restaurantApp.parseGoogleMapsLink(true);
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !document.getElementById('edit-modal').classList.contains('hidden')) {
                        this.closeEditModal();
                    }
                    if (e.key === 'Escape' && !document.getElementById('restaurant-details-modal').classList.contains('hidden')) {
                        closeRestaurantDetails();
                    }
                });
            }

            async openEditModal(restaurantId) {
                try {
                    this.currentRestaurantId = restaurantId;
                    
                    const modal = document.getElementById('edit-modal');
                    modal.classList.remove('hidden');
                    
                    const response = await fetch(`/api/restaurants/${restaurantId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch restaurant data');
                    }
                    
                    const restaurant = await response.json();
                    this.populateEditForm(restaurant);
                    
                } catch (error) {
                    console.error('Error opening edit modal:', error);
                    this.showMessage('Error loading restaurant data', 'error');
                    this.closeEditModal();
                }
            }

            populateEditForm(restaurant) {
                document.getElementById('edit-restaurant-id').value = restaurant.id;
                document.getElementById('edit-name').value = restaurant.name || '';
                document.getElementById('edit-borough').value = restaurant.borough || '';
                document.getElementById('edit-neighborhood').value = restaurant.neighborhoods ? restaurant.neighborhoods.join(', ') : '';
                document.getElementById('edit-status').value = restaurant.status || 'Unvisited';
                document.getElementById('edit-types').value = restaurant.types ? restaurant.types.join(', ') : '';
                document.getElementById('edit-cuisines').value = restaurant.cuisines ? restaurant.cuisines.join(', ') : '';
                document.getElementById('edit-tags').value = restaurant.tags ? restaurant.tags.map(tag => tag.name).join(', ') : '';
                document.getElementById('edit-latitude').value = restaurant.latitude || '';
                document.getElementById('edit-longitude').value = restaurant.longitude || '';
                document.getElementById('edit-website').value = restaurant.website_link || '';
                document.getElementById('edit-what-to-order').value = restaurant.what_to_order || '';
                document.getElementById('edit-notes').value = restaurant.notes || '';
                document.getElementById('edit-liked').checked = restaurant.liked;
                
                // Load happy hour checkbox and data
                const hasHappyHour = restaurant.has_happy_hour || restaurant.happy_hour_data || restaurant.happy_hour;
                document.getElementById('edit-has-happy-hour').checked = hasHappyHour;
                toggleHappyHourDetails(true); // Show/hide details based on checkbox
                
                let happyHourData = null;
                if (restaurant.happy_hour_data) {
                    try {
                        happyHourData = typeof restaurant.happy_hour_data === 'string' 
                            ? JSON.parse(restaurant.happy_hour_data) 
                            : restaurant.happy_hour_data;
                    } catch (e) {
                        console.error('Error parsing happy hour data:', e);
                    }
                }
                if (hasHappyHour) {
                    loadHappyHourData(happyHourData, true);
                }
            }

            closeEditModal() {
                document.getElementById('edit-modal').classList.add('hidden');
                this.currentRestaurantId = null;
                document.getElementById('edit-restaurant-form').reset();
                
                // Clear location helper fields and status
                document.getElementById('edit-address-input').value = '';
                document.getElementById('edit-maps-link-input').value = '';
                document.getElementById('edit-location-status').style.display = 'none';
            }

            async handleEditSubmit(e) {
                e.preventDefault();
                
                if (!this.currentRestaurantId) {
                    this.showMessage('No restaurant selected for editing', 'error');
                    return;
                }

                try {
                    const formData = {
                        name: document.getElementById('edit-name').value.trim(),
                        borough: document.getElementById('edit-borough').value,
                        neighborhood: document.getElementById('edit-neighborhood').value.trim(),
                        status: document.getElementById('edit-status').value,
                        liked: document.getElementById('edit-liked').checked,
                        has_happy_hour: document.getElementById('edit-has-happy-hour').checked,
                        happy_hour_data: document.getElementById('edit-has-happy-hour').checked ? collectHappyHourData(true) : null,
                        website_link: document.getElementById('edit-website').value.trim(),
                        what_to_order: document.getElementById('edit-what-to-order').value.trim(),
                        notes: document.getElementById('edit-notes').value.trim(),
                        latitude: this.parseFloat(document.getElementById('edit-latitude').value),
                        longitude: this.parseFloat(document.getElementById('edit-longitude').value),
                        cuisines: this.parseCommaSeparated(document.getElementById('edit-cuisines').value),
                        types: this.parseCommaSeparated(document.getElementById('edit-types').value),
                        neighborhoods: this.parseCommaSeparated(document.getElementById('edit-neighborhood').value),
                        tags: this.parseCommaSeparated(document.getElementById('edit-tags').value)
                    };

                    if (!formData.name) {
                        this.showMessage('Restaurant name is required', 'error');
                        return;
                    }

                    const response = await fetch(`/api/restaurants/${this.currentRestaurantId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update restaurant');
                    }

                    this.showMessage('Restaurant updated successfully!', 'success');
                    this.closeEditModal();
                    
                    // Refresh the restaurant list
                    if (window.restaurantApp) {
                        await window.restaurantApp.loadRestaurants();
                        
                        // Also refresh map if it's initialized
                        if (window.restaurantApp.map) {
                            await window.restaurantApp.loadRestaurantsOnMap();
                        }
                    }

                } catch (error) {
                    console.error('Error updating restaurant:', error);
                    this.showMessage('Error updating restaurant: ' + error.message, 'error');
                }
            }

            async handleDelete() {
                if (!this.currentRestaurantId) return;

                const restaurantName = document.getElementById('edit-name').value;
                if (!confirm(`Are you sure you want to delete "${restaurantName}"? This action cannot be undone.`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/restaurants/${this.currentRestaurantId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to delete restaurant');
                    }

                    this.showMessage('Restaurant deleted successfully!', 'success');
                    this.closeEditModal();
                    
                    if (window.restaurantApp) {
                        await window.restaurantApp.loadRestaurants();
                        
                        // Also refresh map if it's initialized
                        if (window.restaurantApp.map) {
                            await window.restaurantApp.loadRestaurantsOnMap();
                        }
                    }

                } catch (error) {
                    console.error('Error deleting restaurant:', error);
                    this.showMessage('Error deleting restaurant: ' + error.message, 'error');
                }
            }

            parseFloat(value) {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? null : parsed;
            }

            parseCommaSeparated(value) {
                if (!value || !value.trim()) return [];
                return value.split(',').map(item => item.trim()).filter(item => item);
            }

            showMessage(message, type = 'info') {
                if (window.restaurantApp) {
                    window.restaurantApp.showMessage(message, type);
                }
            }

            addEditButtonToRestaurant(restaurantElement, restaurantId) {
                if (restaurantElement.querySelector('.edit-restaurant-btn')) {
                    return;
                }

                const editButton = document.createElement('button');
                editButton.className = 'edit-restaurant-btn';
                editButton.textContent = '✏️';
                editButton.onclick = (e) => {
                    e.stopPropagation();
                    this.openEditModal(restaurantId);
                };

                const restaurantActions = restaurantElement.querySelector('.restaurant-actions');
                if (restaurantActions) {
                    restaurantActions.appendChild(editButton);
                }
            }
        }

        // Global functions
        function applyFilters() {
            if (window.restaurantApp) {
                // Get dropdown values
                const searchFilter = document.getElementById('search-filter').value;
                const cuisineFilter = document.getElementById('cuisine-filter').value;
                const neighborhoodFilter = document.getElementById('neighborhood-filter').value;
                const boroughFilter = document.getElementById('borough-filter').value;
                const typeFilter = document.getElementById('type-filter').value;
                const tagsFilter = document.getElementById('tags-filter').value;

                // Update filters object
                window.restaurantApp.currentFilters = {};
                
                if (searchFilter) {
                    window.restaurantApp.currentFilters.search = searchFilter;
                }
                if (cuisineFilter) {
                    window.restaurantApp.currentFilters.cuisines = cuisineFilter;
                }
                if (neighborhoodFilter) {
                    window.restaurantApp.currentFilters.neighborhoods = neighborhoodFilter;
                }
                if (boroughFilter) {
                    window.restaurantApp.currentFilters.boroughs = boroughFilter;
                }
                if (typeFilter) {
                    window.restaurantApp.currentFilters.types = typeFilter;
                }
                if (tagsFilter) {
                    window.restaurantApp.currentFilters.tags = tagsFilter;
                }

                // Get button filter values
                const activeStatusBtn = document.querySelector('[data-filter="status"].active');
                const activeLikedBtn = document.querySelector('[data-filter="liked"].active');
                
                if (activeStatusBtn && activeStatusBtn.getAttribute('data-value')) {
                    window.restaurantApp.currentFilters.status = activeStatusBtn.getAttribute('data-value');
                }
                if (activeLikedBtn && activeLikedBtn.getAttribute('data-value')) {
                    window.restaurantApp.currentFilters.liked = activeLikedBtn.getAttribute('data-value');
                }

                window.restaurantApp.loadRestaurants();
            }
        }

        function filterByBorough(borough) {
            // Set the borough filter dropdown
            const boroughSelect = document.getElementById('borough-filter');
            if (boroughSelect) {
                boroughSelect.value = borough;
            }
            
            // Clear other filters to focus on this borough
            clearAllFilters();
            
            // Apply the borough filter
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = { boroughs: borough };
                window.restaurantApp.loadRestaurants();
            }
        }

        function filterByNeighborhood(neighborhood) {
            console.log('filterByNeighborhood called with:', neighborhood);
            
            // Clear other filters first
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = {};
            }
            
            // Clear all dropdowns and search except neighborhood
            document.getElementById('search-filter').value = '';
            document.getElementById('cuisine-filter').value = '';
            document.getElementById('borough-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('tags-filter').value = '';
            
            // Set the neighborhood filter dropdown
            const neighborhoodSelect = document.getElementById('neighborhood-filter');
            if (neighborhoodSelect) {
                neighborhoodSelect.value = neighborhood;
            }
            
            // Clear active filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-value') === '') {
                    btn.classList.add('active');
                }
            });
            
            // Apply the neighborhood filter
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = { neighborhoods: neighborhood };
                console.log('Current filters set to:', window.restaurantApp.currentFilters);
                window.restaurantApp.loadRestaurants();
            }
        }

        function filterByCuisine(cuisine) {
            // Set the cuisine filter dropdown
            const cuisineSelect = document.getElementById('cuisine-filter');
            if (cuisineSelect) {
                cuisineSelect.value = cuisine;
            }
            
            // Clear other filters to focus on this cuisine
            clearAllFilters();
            
            // Apply the cuisine filter
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = { cuisines: cuisine };
                window.restaurantApp.loadRestaurants();
            }
        }

        function filterByType(type) {
            // Set the type filter dropdown
            const typeSelect = document.getElementById('type-filter');
            if (typeSelect) {
                typeSelect.value = type;
            }
            
            // Clear other filters to focus on this type
            clearAllFilters();
            
            // Apply the type filter
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = { types: type };
                window.restaurantApp.loadRestaurants();
            }
        }

        function filterByDay(day) {
            if (window.restaurantApp && window.restaurantApp.currentView === 'happyhour') {
                // Set the day filter and apply filters
                const dayFilter = document.getElementById('day-filter');
                if (dayFilter) {
                    dayFilter.value = day;
                    applyHappyHourFilters();
                }
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        function showView(viewName) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Clean up previous view timers
            if (window.restaurantApp && window.restaurantApp.timeUpdateInterval) {
                clearInterval(window.restaurantApp.timeUpdateInterval);
                window.restaurantApp.timeUpdateInterval = null;
            }
            
            // Smooth transition between views
            const currentView = document.querySelector('#database-view:not(.hidden), #map-view:not(.hidden), #happyhour-view:not(.hidden), #add-view:not(.hidden)');
            const targetView = document.getElementById(`${viewName}-view`);
            
            if (currentView && currentView !== targetView) {
                // Fade out current view
                currentView.style.opacity = '0';
                currentView.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    currentView.classList.add('hidden');
                    currentView.style.opacity = '';
                    currentView.style.transform = '';
                    
                    // Fade in target view
                    targetView.classList.remove('hidden');
                    targetView.style.opacity = '0';
                    targetView.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        targetView.style.opacity = '1';
                        targetView.style.transform = 'translateY(0)';
                    }, 50);
                }, 200);
            } else {
                // Hide all views
                document.querySelectorAll('#database-view, #map-view, #happyhour-view, #add-view').forEach(view => {
                    view.classList.add('hidden');
                });
                
                // Show selected view
                targetView.classList.remove('hidden');
            }
            
            // Initialize based on view
            if (viewName === 'map' && window.restaurantApp) {
                setTimeout(() => {
                    window.restaurantApp.initializeMap();
                }, 300);
            } else if (viewName === 'happyhour' && window.restaurantApp) {
                setTimeout(() => {
                    window.restaurantApp.initializeHappyHour();
                }, 100);
            }
        }


        function clearAllFilters() {
            // Reset all dropdowns and search
            document.getElementById('search-filter').value = '';
            document.getElementById('cuisine-filter').value = '';
            document.getElementById('neighborhood-filter').value = '';
            document.getElementById('borough-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('tags-filter').value = '';
            
            // Reset all filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-value') === '') {
                    btn.classList.add('active');
                }
            });
            
            // Clear filters and reload
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = {};
                window.restaurantApp.loadRestaurants();
            }
        }

        function applyMapFilters() {
            if (window.restaurantApp) {
                // Get dropdown values for map
                const boroughFilter = document.getElementById('map-borough-filter').value;
                const cuisineFilter = document.getElementById('map-cuisine-filter').value;

                // Update filters object
                window.restaurantApp.currentFilters = {};
                
                if (boroughFilter) {
                    window.restaurantApp.currentFilters.boroughs = boroughFilter;
                }
                if (cuisineFilter) {
                    window.restaurantApp.currentFilters.cuisines = cuisineFilter;
                }

                // Get button filter values for map
                const activeStatusBtn = document.querySelector('#map-view [data-filter="status"].active');
                const activeLikedBtn = document.querySelector('#map-view [data-filter="liked"].active');
                
                if (activeStatusBtn && activeStatusBtn.getAttribute('data-value')) {
                    window.restaurantApp.currentFilters.status = activeStatusBtn.getAttribute('data-value');
                }
                if (activeLikedBtn && activeLikedBtn.getAttribute('data-value')) {
                    window.restaurantApp.currentFilters.liked = activeLikedBtn.getAttribute('data-value');
                }

                window.restaurantApp.loadRestaurantsOnMap();
            }
        }

        function handleMapFilterClick(filterBtn) {
            const filterType = filterBtn.getAttribute('data-filter');
            
            // Remove active class from all buttons in this filter group within the map view
            document.querySelectorAll(`#map-view [data-filter="${filterType}"]`).forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            filterBtn.classList.add('active');
            
            // Apply map filters
            applyMapFilters();
        }

        function clearMapFilters() {
            // Reset map dropdowns
            document.getElementById('map-borough-filter').value = '';
            document.getElementById('map-cuisine-filter').value = '';
            
            // Reset map filter buttons
            document.querySelectorAll('#map-view .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-value') === '') {
                    btn.classList.add('active');
                }
            });
            
            // Clear filters and reload map
            if (window.restaurantApp) {
                window.restaurantApp.currentFilters = {};
                window.restaurantApp.loadRestaurantsOnMap();
            }
        }

        function findUserLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (window.restaurantApp && window.restaurantApp.map) {
                        // Add user location marker
                        const userMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background-color: var(--accent-color); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10],
                                className: 'user-location-marker'
                            })
                        }).addTo(window.restaurantApp.map);
                        
                        userMarker.bindPopup('📍 Your Location').openPopup();
                        
                        // Center map on user location
                        window.restaurantApp.map.setView([lat, lng], 14);
                    }
                },
                function(error) {
                    let message = 'Unable to retrieve your location: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Location access denied by user.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            message += 'Location request timed out.';
                            break;
                        default:
                            message += 'An unknown error occurred.';
                            break;
                    }
                    alert(message);
                }
            );
        }

        // Happy Hour filter functions
        function applyHappyHourFilters() {
            if (window.restaurantApp) {
                // Clear previous filters
                window.restaurantApp.happyHourFilters = {};
                
                // Get selected days
                const selectedDays = [];
                document.querySelectorAll('.day-filter-btn.active').forEach(btn => {
                    const day = btn.getAttribute('data-day');
                    if (day !== 'all') {
                        selectedDays.push(day);
                    }
                });
                
                if (selectedDays.length > 0) {
                    window.restaurantApp.happyHourFilters.days = selectedDays;
                }
                
                // Get dropdown values
                const neighborhoodFilter = document.getElementById('hh-neighborhood-filter').value;
                const hasFoodFilter = document.getElementById('has-food-filter').value;
                
                if (neighborhoodFilter) {
                    window.restaurantApp.happyHourFilters.neighborhood = neighborhoodFilter;
                }
                if (hasFoodFilter) {
                    window.restaurantApp.happyHourFilters.hasFood = hasFoodFilter;
                }

                window.restaurantApp.loadHappyHours();
            }
        }


        function toggleDayFilter(button) {
            const day = button.getAttribute('data-day');
            
            if (day === 'all') {
                // If "All Days" is clicked, clear all other selections
                document.querySelectorAll('.day-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            } else {
                // If a specific day is clicked, remove "All Days" and toggle this day
                document.querySelector('.day-filter-btn[data-day="all"]').classList.remove('active');
                button.classList.toggle('active');
                
                // If no days are selected, automatically select "All Days"
                const activeDays = document.querySelectorAll('.day-filter-btn.active:not([data-day="all"])');
                if (activeDays.length === 0) {
                    document.querySelector('.day-filter-btn[data-day="all"]').classList.add('active');
                }
            }
            
            applyHappyHourFilters();
        }

        function clearHappyHourFilters() {
            // Reset day buttons
            document.querySelectorAll('.day-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.day-filter-btn[data-day="all"]').classList.add('active');
            
            // Reset dropdowns
            document.getElementById('hh-neighborhood-filter').value = '';
            document.getElementById('has-food-filter').value = '';
            
            // Clear filters and reload
            if (window.restaurantApp) {
                window.restaurantApp.happyHourFilters = {};
                window.restaurantApp.loadHappyHours();
            }
        }

        async function openRestaurantDetails(restaurantId) {
            try {
                // Fetch restaurant data
                const response = await fetch(`/api/restaurants/${restaurantId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch restaurant data');
                }
                const restaurant = await response.json();
                
                // Populate modal content
                document.getElementById('details-restaurant-name').textContent = restaurant.name;
                
                const contentDiv = document.getElementById('restaurant-details-content');
                contentDiv.innerHTML = `
                    <div class="details-grid">
                        <div class="details-section">
                            <h3>📍 Location</h3>
                            <div class="detail-item">
                                <div class="detail-label">Borough</div>
                                <div class="detail-value">${restaurant.borough || 'Not specified'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Neighborhoods</div>
                                <div class="detail-value">${restaurant.neighborhoods && restaurant.neighborhoods.length ? restaurant.neighborhoods.join(', ') : 'Not specified'}</div>
                            </div>
                            ${restaurant.latitude && restaurant.longitude ? `
                            <div class="detail-item">
                                <div class="detail-label">Coordinates</div>
                                <div class="detail-value">${restaurant.latitude}, ${restaurant.longitude}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="details-section">
                            <h3>📊 Status</h3>
                            <div class="detail-item">
                                <div class="detail-label">Visit Status</div>
                                <div class="detail-value">
                                    <span class="status-badge ${restaurant.status === 'Visited' ? 'status-visited' : 'status-unvisited'}">
                                        ${restaurant.status === 'Visited' ? '✅ Visited' : '⏳ Not Visited'}
                                    </span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Liked</div>
                                <div class="detail-value">
                                    <span class="liked-badge">${restaurant.liked ? '❤️ Liked' : '♡ Not Liked'}</span>
                                </div>
                            </div>
                            ${restaurant.website_link ? `
                            <div class="detail-item">
                                <div class="detail-label">Website</div>
                                <div class="detail-value">
                                    <a href="${restaurant.website_link}" target="_blank" class="website-link">
                                        🔗 Visit
                                    </a>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="details-section">
                            <h3>🏷️ Categories</h3>
                            ${restaurant.cuisines && restaurant.cuisines.length ? `
                            <div class="detail-item">
                                <div class="detail-label">Cuisine</div>
                                <div class="detail-value">
                                    ${restaurant.cuisines.map(cuisine => `<span class="cuisine-tag">${cuisine}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            ${restaurant.types && restaurant.types.length ? `
                            <div class="detail-item">
                                <div class="detail-label">Type</div>
                                <div class="detail-value">
                                    ${restaurant.types.map(type => `<span class="type-tag">${type}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            ${restaurant.tags && restaurant.tags.length ? `
                            <div class="detail-item">
                                <div class="detail-label">Tags</div>
                                <div class="detail-value">${restaurant.tags.map(tag => `<span class="cuisine-tag">${tag.name}</span>`).join('')}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${restaurant.what_to_order ? `
                    <div class="details-wide-section">
                        <h3>🌟 What to Order</h3>
                        <div class="detail-value">${restaurant.what_to_order}</div>
                    </div>
                    ` : ''}
                    
                    ${restaurant.notes ? `
                    <div class="details-wide-section">
                        <h3>📝 Notes</h3>
                        <div class="detail-value">${restaurant.notes}</div>
                    </div>
                    ` : ''}
                    
                    ${restaurant.happy_hour ? `
                    <div class="details-wide-section">
                        <h3>🍹 Happy Hour</h3>
                        <div class="detail-value">${restaurant.happy_hour}</div>
                    </div>
                    ` : ''}
                    
                    <div class="details-actions">
                        <button onclick="event.stopPropagation(); toggleLiked(${restaurant.id}, ${!restaurant.liked}); setTimeout(() => openRestaurantDetails(${restaurant.id}), 100)" 
                                class="action-btn">
                            ${restaurant.liked ? '❤️ Unlike' : '♡ Like'}
                        </button>
                        <button onclick="event.stopPropagation(); toggleStatus(${restaurant.id}); setTimeout(() => openRestaurantDetails(${restaurant.id}), 100)" 
                                class="action-btn">
                            ${restaurant.status === 'Visited' ? '✅ Mark Unvisited' : '📍 Mark Visited'}
                        </button>
                        <button onclick="event.stopPropagation(); window.restaurantEditor.openEditModal(${restaurant.id}); closeRestaurantDetails()" 
                                class="action-btn">
                            ✏️ Edit
                        </button>
                    </div>
                `;
                
                // Show modal
                document.getElementById('restaurant-details-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading restaurant details:', error);
            }
        }
        
        function closeRestaurantDetails() {
            document.getElementById('restaurant-details-modal').classList.add('hidden');
        }

        function toggleHappyHourDetails(restaurantId) {
            // Close all other expanded happy hour details
            document.querySelectorAll('.hh-restaurant-details').forEach(detail => {
                if (detail.id !== `hh-details-${restaurantId}`) {
                    detail.style.display = 'none';
                }
            });
            
            // Toggle the clicked one
            const detailsDiv = document.getElementById(`hh-details-${restaurantId}`);
            if (detailsDiv) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                } else {
                    detailsDiv.style.display = 'none';
                }
            }
        }
        
        function toggleRestaurantDetails(restaurantId) {
            // Close all other expanded restaurant details
            document.querySelectorAll('.restaurant-details').forEach(detail => {
                if (detail.id !== `restaurant-details-${restaurantId}`) {
                    detail.style.display = 'none';
                }
            });
            
            // Toggle the clicked one
            const detailsDiv = document.getElementById(`restaurant-details-${restaurantId}`);
            if (detailsDiv) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                } else {
                    detailsDiv.style.display = 'none';
                }
            }
        }

        function switchHappyHourView(viewType) {
            const tableView = document.getElementById('happy-hour-table-view');
            const timelineView = document.getElementById('happy-hour-timeline-view');
            const tableBtn = document.getElementById('table-view-btn');
            const timelineBtn = document.getElementById('timeline-view-btn');
            const tableHeader = document.querySelector('#happy-hour-content .happy-hour-header');
            const timelineHeader = document.getElementById('timeline-header');
            
            if (viewType === 'timeline') {
                tableView.classList.add('hidden');
                timelineView.classList.remove('hidden');
                tableBtn.classList.remove('active');
                timelineBtn.classList.add('active');
                
                // Hide table headers and show timeline header
                if (tableHeader) {
                    tableHeader.style.display = 'none';
                }
                if (timelineHeader) {
                    timelineHeader.classList.remove('hidden');
                }
                
                // Generate timeline when switching to timeline view
                if (window.restaurantApp) {
                    window.restaurantApp.generateTimeline();
                }
            } else {
                tableView.classList.remove('hidden');
                timelineView.classList.add('hidden');
                tableBtn.classList.add('active');
                timelineBtn.classList.remove('active');
                
                // Show table headers and hide timeline header
                if (tableHeader) {
                    tableHeader.style.display = 'block';
                }
                if (timelineHeader) {
                    timelineHeader.classList.add('hidden');
                }
            }
        }

        async function toggleLiked(restaurantId, liked) {
            try {
                const response = await fetch(`/api/restaurants/${restaurantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ liked })
                });
                
                if (response.ok && window.restaurantApp) {
                    await window.restaurantApp.loadRestaurants();
                    
                    // Also refresh map if it's initialized
                    if (window.restaurantApp.map) {
                        await window.restaurantApp.loadRestaurantsOnMap();
                    }
                }
            } catch (error) {
                console.error('Error updating liked status:', error);
            }
        }

        async function toggleStatus(restaurantId) {
            try {
                const getResponse = await fetch(`/api/restaurants/${restaurantId}`);
                const restaurant = await getResponse.json();
                
                const newStatus = restaurant.status === 'Visited' ? 'Unvisited' : 'Visited';
                
                const response = await fetch(`/api/restaurants/${restaurantId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok && window.restaurantApp) {
                    await window.restaurantApp.loadRestaurants();
                    
                    // Also refresh map if it's initialized
                    if (window.restaurantApp.map) {
                        await window.restaurantApp.loadRestaurantsOnMap();
                    }
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function addEditButtonsToRestaurants() {
            const restaurantItems = document.querySelectorAll('[data-restaurant-id]');
            restaurantItems.forEach(item => {
                const restaurantId = item.getAttribute('data-restaurant-id');
                if (restaurantId && window.restaurantEditor) {
                    window.restaurantEditor.addEditButtonToRestaurant(item, restaurantId);
                }
            });
        }

        // Initialize app when page loads
        // Random header image function
        let currentImagePath = '';
        
        async function setRandomHeaderImage() {
            try {
                const response = await fetch('/api/images');
                const images = await response.json();
                
                if (images.length === 0) {
                    console.log('No images found in /images folder');
                    return;
                }
                
                const randomImage = images[Math.floor(Math.random() * images.length)];
                currentImagePath = randomImage;
                const headerImage = document.getElementById('header-image');
                
                if (headerImage) {
                    headerImage.style.backgroundImage = `url('${randomImage}')`;
                    
                    // Load saved position for this specific image
                    loadImagePosition(randomImage);
                }
            } catch (error) {
                console.error('Error loading header images:', error);
                // Fallback to a default image or keep current state
            }
        }
        
        // Image Editor Functions
        function toggleImageEditor() {
            const controls = document.getElementById('image-editor-controls');
            const toggleBtn = document.getElementById('edit-toggle-btn');
            
            if (controls.classList.contains('active')) {
                controls.classList.remove('active');
                toggleBtn.textContent = '✏️';
            } else {
                controls.classList.add('active');
                toggleBtn.textContent = '✖️';
            }
        }
        
        function adjustImagePosition(value) {
            const headerImage = document.getElementById('header-image');
            if (headerImage && currentImagePath) {
                // Convert slider value (0-100) to background position
                // 0 = top, 50 = center, 100 = bottom
                const percentage = value;
                headerImage.style.backgroundPosition = `center ${percentage}%`;
                
                // Save position for this specific image
                saveImagePosition(currentImagePath, percentage);
            }
        }
        
        function resetImagePosition() {
            const headerImage = document.getElementById('header-image');
            const slider = document.getElementById('position-slider');
            
            if (headerImage) {
                headerImage.style.backgroundPosition = 'center center';
            }
            if (slider) {
                slider.value = 50;
            }
            
            // Remove saved position for current image
            if (currentImagePath) {
                removeImagePosition(currentImagePath);
            }
        }
        
        async function getNewRandomImage() {
            await setRandomHeaderImage();
        }
        
        // Save position for a specific image
        function saveImagePosition(imagePath, position) {
            const positions = JSON.parse(localStorage.getItem('imagePositions') || '{}');
            positions[imagePath] = position;
            localStorage.setItem('imagePositions', JSON.stringify(positions));
        }
        
        // Load position for a specific image
        function loadImagePosition(imagePath) {
            const positions = JSON.parse(localStorage.getItem('imagePositions') || '{}');
            const savedPosition = positions[imagePath];
            
            const headerImage = document.getElementById('header-image');
            const slider = document.getElementById('position-slider');
            
            if (savedPosition !== undefined) {
                if (headerImage) {
                    headerImage.style.backgroundPosition = `center ${savedPosition}%`;
                }
                if (slider) {
                    slider.value = savedPosition;
                }
            } else {
                // Default to center if no saved position
                if (headerImage) {
                    headerImage.style.backgroundPosition = 'center center';
                }
                if (slider) {
                    slider.value = 50;
                }
            }
        }
        
        // Remove position for a specific image
        function removeImagePosition(imagePath) {
            const positions = JSON.parse(localStorage.getItem('imagePositions') || '{}');
            delete positions[imagePath];
            localStorage.setItem('imagePositions', JSON.stringify(positions));
        }

        // Happy Hour Toggle Function
        function toggleHappyHourDetails(isEdit = false) {
            const checkboxId = isEdit ? 'edit-has-happy-hour' : 'has-happy-hour';
            const detailsId = isEdit ? 'edit-happy-hour-details' : 'happy-hour-details';
            
            const checkbox = document.getElementById(checkboxId);
            const details = document.getElementById(detailsId);
            
            if (checkbox.checked) {
                details.style.display = 'block';
                // Re-add event listeners to time inputs when they become visible
                setTimeout(() => addTimeInputListeners(), 100);
            } else {
                details.style.display = 'none';
                // Clear the form when hiding
                clearAllHappyHour(isEdit);
            }
        }

        // Happy Hour Grid Functions
        function collectHappyHourData(isEdit = false) {
            const gridId = isEdit ? 'edit-happy-hour-grid' : 'happy-hour-grid';
            const grid = document.getElementById(gridId);
            const dayRows = grid.querySelectorAll('.hh-day-row');
            
            // Get shared specials
            const sharedSpecialsId = isEdit ? 'edit-hh-shared-specials' : 'hh-shared-specials';
            const sharedSpecials = document.getElementById(sharedSpecialsId).value.trim();
            
            const schedules = [];
            
            dayRows.forEach(row => {
                const day = row.dataset.day;
                const startTime = row.querySelector('.hh-start-time').value;
                const endTime = row.querySelector('.hh-end-time').value;
                
                // Only include days that have at least a start time
                if (startTime) {
                    schedules.push({
                        days: [day],
                        startTime: startTime,
                        endTime: endTime || null,
                        offers: {
                            specials: sharedSpecials ? sharedSpecials.split(',').map(s => s.trim()).filter(s => s) : [],
                            notes: null
                        }
                    });
                }
            });
            
            return { schedules };
        }
        
        function loadHappyHourData(data, isEdit = false) {
            const gridId = isEdit ? 'edit-happy-hour-grid' : 'happy-hour-grid';
            const grid = document.getElementById(gridId);
            const dayRows = grid.querySelectorAll('.hh-day-row');
            
            // Get shared specials input
            const sharedSpecialsId = isEdit ? 'edit-hh-shared-specials' : 'hh-shared-specials';
            const sharedSpecialsInput = document.getElementById(sharedSpecialsId);
            
            // Clear all inputs first
            dayRows.forEach(row => {
                row.querySelector('.hh-start-time').value = '';
                row.querySelector('.hh-end-time').value = '';
            });
            
            if (sharedSpecialsInput) sharedSpecialsInput.value = '';
            
            if (data && data.schedules && data.schedules.length > 0) {
                // Extract shared specials from first schedule (they should be the same for all)
                const firstSchedule = data.schedules[0];
                if (firstSchedule.offers) {
                    // Handle both new format (specials) and legacy format (drinks + food)
                    let specialsText = '';
                    if (firstSchedule.offers.specials) {
                        specialsText = firstSchedule.offers.specials.join(', ');
                    } else if (firstSchedule.offers.drinks || firstSchedule.offers.food) {
                        // Convert legacy format to combined
                        const drinks = firstSchedule.offers.drinks || [];
                        const food = firstSchedule.offers.food || [];
                        specialsText = [...drinks, ...food].join(', ');
                    }
                    
                    if (sharedSpecialsInput) {
                        sharedSpecialsInput.value = specialsText;
                    }
                }
                
                // Load time data for each day
                data.schedules.forEach(schedule => {
                    schedule.days.forEach(day => {
                        const row = grid.querySelector(`[data-day="${day}"]`);
                        if (row) {
                            row.querySelector('.hh-start-time').value = schedule.startTime || '';
                            row.querySelector('.hh-end-time').value = schedule.endTime || '';
                        }
                    });
                });
            }
        }
        
        function applyToWeekdays(isEdit = false) {
            // First check if happy hour is enabled
            const checkboxId = isEdit ? 'edit-has-happy-hour' : 'has-happy-hour';
            const checkbox = document.getElementById(checkboxId);
            
            if (!checkbox || !checkbox.checked) {
                alert('Please check "Has Happy Hour" first to enable the schedule grid');
                return;
            }
            
            const gridId = isEdit ? 'edit-happy-hour-grid' : 'happy-hour-grid';
            const grid = document.getElementById(gridId);
            
            if (!grid) {
                alert('Happy hour grid not found. Please check "Has Happy Hour" first.');
                return;
            }
            
            const weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            
            // Get values from Monday as template
            const mondayRow = grid.querySelector('[data-day="monday"]');
            if (!mondayRow) {
                alert('Monday row not found in happy hour grid');
                return;
            }
            
            const startTimeInput = mondayRow.querySelector('.hh-start-time');
            const endTimeInput = mondayRow.querySelector('.hh-end-time');
            
            if (!startTimeInput || !endTimeInput) {
                alert('Time input fields not found. Please check "Has Happy Hour" first.');
                return;
            }
            
            // Normalize manually typed input
            const startTime = normalizeTimeInput(startTimeInput);
            const endTime = normalizeTimeInput(endTimeInput);
            
            if (!startTime) {
                alert('Please enter a valid start time for Monday first (e.g., 17:00 or 1700). Current value: "' + startTimeInput.value + '"');
                return;
            }
            
            // Apply to all weekdays
            let applied = 0;
            weekdays.forEach(day => {
                const row = grid.querySelector(`[data-day="${day}"]`);
                if (row) {
                    const startInput = row.querySelector('.hh-start-time');
                    const endInput = row.querySelector('.hh-end-time');
                    
                    if (startInput) {
                        startInput.value = startTime;
                        applied++;
                    }
                    if (endInput) {
                        endInput.value = endTime;
                    }
                }
            });
            
            // Show confirmation
            const endMsg = endTime ? ` and end time (${endTime})` : '';
            alert(`✅ Applied Monday's start time (${startTime})${endMsg} to ${applied} weekdays`);
        }
        
        function applyToWeekends(isEdit = false) {
            // First check if happy hour is enabled
            const checkboxId = isEdit ? 'edit-has-happy-hour' : 'has-happy-hour';
            const checkbox = document.getElementById(checkboxId);
            
            if (!checkbox || !checkbox.checked) {
                alert('Please check "Has Happy Hour" first to enable the schedule grid');
                return;
            }
            
            const gridId = isEdit ? 'edit-happy-hour-grid' : 'happy-hour-grid';
            const grid = document.getElementById(gridId);
            
            if (!grid) {
                alert('Happy hour grid not found. Please check "Has Happy Hour" first.');
                return;
            }
            
            const weekends = ['saturday', 'sunday'];
            
            // Get values from Saturday as template
            const saturdayRow = grid.querySelector('[data-day="saturday"]');
            if (!saturdayRow) {
                alert('Saturday row not found in happy hour grid');
                return;
            }
            
            const startTimeInput = saturdayRow.querySelector('.hh-start-time');
            const endTimeInput = saturdayRow.querySelector('.hh-end-time');
            
            if (!startTimeInput || !endTimeInput) {
                alert('Time input fields not found. Please check "Has Happy Hour" first.');
                return;
            }
            
            // Normalize manually typed input
            const startTime = normalizeTimeInput(startTimeInput);
            const endTime = normalizeTimeInput(endTimeInput);
            
            if (!startTime) {
                alert('Please enter a valid start time for Saturday first (e.g., 17:00 or 1700). Current value: "' + startTimeInput.value + '"');
                return;
            }
            
            // Apply to all weekends
            let applied = 0;
            weekends.forEach(day => {
                const row = grid.querySelector(`[data-day="${day}"]`);
                if (row) {
                    const startInput = row.querySelector('.hh-start-time');
                    const endInput = row.querySelector('.hh-end-time');
                    
                    if (startInput) {
                        startInput.value = startTime;
                        applied++;
                    }
                    if (endInput) {
                        endInput.value = endTime;
                    }
                }
            });
            
            // Show confirmation
            const endMsg = endTime ? ` and end time (${endTime})` : '';
            alert(`✅ Applied Saturday's start time (${startTime})${endMsg} to ${applied} weekend days`);
        }
        
        function clearAllHappyHour(isEdit = false) {
            const gridId = isEdit ? 'edit-happy-hour-grid' : 'happy-hour-grid';
            const grid = document.getElementById(gridId);
            const dayRows = grid.querySelectorAll('.hh-day-row');
            
            // Clear shared specials
            const sharedSpecialsId = isEdit ? 'edit-hh-shared-specials' : 'hh-shared-specials';
            const sharedSpecialsInput = document.getElementById(sharedSpecialsId);
            
            if (sharedSpecialsInput) sharedSpecialsInput.value = '';
            
            // Clear time fields
            dayRows.forEach(row => {
                row.querySelector('.hh-start-time').value = '';
                row.querySelector('.hh-end-time').value = '';
            });
        }

        // Function to normalize and validate time input values
        function normalizeTimeInput(input) {
            let value = input.value.trim();
            
            // Handle different manual input formats
            if (value && !value.includes(':')) {
                // Handle "1700" -> "17:00"
                if (value.length === 4 && /^\d{4}$/.test(value)) {
                    value = value.substring(0, 2) + ':' + value.substring(2);
                }
                // Handle "17" -> "17:00"
                else if (value.length <= 2 && /^\d{1,2}$/.test(value)) {
                    const hour = parseInt(value);
                    if (hour >= 0 && hour <= 23) {
                        value = value.padStart(2, '0') + ':00';
                    }
                }
            }
            
            // Validate the format and range
            if (value && !/^\d{2}:\d{2}$/.test(value)) {
                return null; // Invalid format
            }
            
            if (value) {
                const [hour, minute] = value.split(':').map(Number);
                if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                    return null; // Invalid range
                }
            }
            
            input.value = value;
            return value;
        }

        // Add event listeners to time inputs for better manual typing support
        function addTimeInputListeners() {
            const timeInputs = document.querySelectorAll('input[type="time"]');
            timeInputs.forEach(input => {
                // Handle blur event (when user leaves the field)
                input.addEventListener('blur', function() {
                    normalizeTimeInput(this);
                });
                
                // Handle Enter key
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        normalizeTimeInput(this);
                        this.blur();
                    }
                });
                
                // Handle input event for real-time validation
                input.addEventListener('input', function() {
                    // Remove any non-digit, non-colon characters
                    this.value = this.value.replace(/[^\d:]/g, '');
                });
            });
        }

        // Natural Language Happy Hour Parser
        function parseNaturalLanguage(isEdit = false) {
            const inputId = isEdit ? 'edit-hh-natural-input' : 'hh-natural-input';
            const input = document.getElementById(inputId);
            const text = input.value.trim().toLowerCase();
            
            if (!text) {
                alert('Please enter some text to parse');
                return;
            }
            
            // Clear existing times first
            clearAllHappyHour(isEdit);
            
            const results = parseHappyHourText(text);
            
            if (results.length === 0) {
                alert('Could not parse the text. Please try formats like:\n• weekdays 4pm - 6pm\n• monday to thursday 5-7pm\n• tuesday to saturday 1pm to 3pm\n• mon-thu 6pm-8pm\n• weekends 3pm-5pm\n• wednesday 1am-2am');
                return;
            }
            
            // Apply parsed results to grid
            applyParsedResults(results, isEdit);
            
            // Show success message
            const summary = results.map(r => `${r.days.join(', ')} ${r.startTime}-${r.endTime}`).join('\n');
            alert(`✅ Parsed and applied:\n${summary}`);
        }

        function parseHappyHourText(text) {
            const results = [];
            
            // Split by common separators (comma, semicolon, newline, "and")
            const segments = text.split(/[,;\n]|(?:\s+and\s+)/i).map(s => s.trim()).filter(s => s);
            
            for (const segment of segments) {
                const parsed = parseTimeSegment(segment);
                if (parsed) {
                    results.push(parsed);
                }
            }
            
            return results;
        }

        function parseDayRange(segment) {
            // Define day mappings for parsing
            const dayMap = {
                'monday': 'monday', 'mon': 'monday',
                'tuesday': 'tuesday', 'tue': 'tuesday', 'tues': 'tuesday',
                'wednesday': 'wednesday', 'wed': 'wednesday',
                'thursday': 'thursday', 'thu': 'thursday', 'thur': 'thursday',
                'friday': 'friday', 'fri': 'friday',
                'saturday': 'saturday', 'sat': 'saturday',
                'sunday': 'sunday', 'sun': 'sunday'
            };
            
            const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            // Patterns for day ranges
            const rangePatterns = [
                // "monday to thursday", "tue to sat", "wednesday through friday"
                /\b(monday|tue?s?day|wed?nesday|thu?r?sday|fri?day|sat?urday|sun?day)\s+(?:to|through|thru)\s+(monday|tue?s?day|wed?nesday|thu?r?sday|fri?day|sat?urday|sun?day)\b/i,
                // "monday - thursday" (with dash and spaces)
                /\b(monday|tue?s?day|wed?nesday|thu?r?sday|fri?day|sat?urday|sun?day)\s*-\s*(monday|tue?s?day|wed?nesday|thu?r?sday|fri?day|sat?urday|sun?day)\b/i,
                // "mon-thu", "tue-sat" (abbreviated with dash)
                /\b(mon|tue|wed|thu|fri|sat|sun)-?(mon|tue|wed|thu|fri|sat|sun)\b/i
            ];
            
            for (const pattern of rangePatterns) {
                const match = segment.match(pattern);
                if (match) {
                    const startDay = match[1].toLowerCase();
                    const endDay = match[2].toLowerCase();
                    
                    // Map abbreviated forms to full names
                    const startDayFull = dayMap[startDay];
                    const endDayFull = dayMap[endDay];
                    
                    if (startDayFull && endDayFull) {
                        return getDayRange(startDayFull, endDayFull, dayOrder);
                    }
                }
            }
            
            return [];
        }

        function getDayRange(startDay, endDay, dayOrder) {
            const startIndex = dayOrder.indexOf(startDay);
            const endIndex = dayOrder.indexOf(endDay);
            
            if (startIndex === -1 || endIndex === -1) {
                return [];
            }
            
            const result = [];
            
            if (startIndex <= endIndex) {
                // Normal range (e.g., monday to thursday)
                for (let i = startIndex; i <= endIndex; i++) {
                    result.push(dayOrder[i]);
                }
            } else {
                // Wraparound range (e.g., friday to monday)
                // From start day to end of week
                for (let i = startIndex; i < dayOrder.length; i++) {
                    result.push(dayOrder[i]);
                }
                // From start of week to end day
                for (let i = 0; i <= endIndex; i++) {
                    result.push(dayOrder[i]);
                }
            }
            
            return result;
        }

        function parseTimeSegment(segment) {
            // Normalize the segment
            segment = segment.replace(/\s+/g, ' ').trim();
            
            // Day patterns
            const dayPatterns = {
                'weekdays?|weekday|mon-fri|monday-friday|m-f': ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                'weekends?|weekend|sat-sun|saturday-sunday|weekend': ['saturday', 'sunday'],
                'daily|everyday|every day|all days?': ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'],
                'mondays?|mon': ['monday'],
                'tuesdays?|tue|tues': ['tuesday'],
                'wednesdays?|wed': ['wednesday'],
                'thursdays?|thu|thur': ['thursday'],
                'fridays?|fri': ['friday'],
                'saturdays?|sat': ['saturday'],
                'sundays?|sun': ['sunday']
            };
            
            // First, check for day ranges (e.g., "monday to thursday", "tue-sat")
            let matchedDays = parseDayRange(segment);
            
            // If no range found, try individual day patterns
            if (matchedDays.length === 0) {
                for (const [pattern, days] of Object.entries(dayPatterns)) {
                    const regex = new RegExp(`\\b(${pattern})\\b`, 'i');
                    if (regex.test(segment)) {
                        matchedDays = days;
                        break;
                    }
                }
            }
            
            if (matchedDays.length === 0) {
                return null; // No days found
            }
            
            // Time patterns - handle various formats
            const timePatterns = [
                // "4pm - 6pm", "4-6pm", "4 - 6 pm"
                /(\d{1,2})(?::(\d{2}))?\s*([ap]m?)?\s*[-–—to]+\s*(\d{1,2})(?::(\d{2}))?\s*([ap]m?)/i,
                // "4pm-6pm", "4-6 pm"
                /(\d{1,2})(?::(\d{2}))?\s*([ap]m?)?\s*[-–—]+\s*(\d{1,2})(?::(\d{2}))?\s*([ap]m?)/i,
                // "from 4pm to 6pm"
                /from\s+(\d{1,2})(?::(\d{2}))?\s*([ap]m?)\s+to\s+(\d{1,2})(?::(\d{2}))?\s*([ap]m?)/i,
                // Military time "1600-1800", "16:00-18:00"
                /(\d{1,2}):?(\d{2})\s*[-–—to]+\s*(\d{1,2}):?(\d{2})/i
            ];
            
            let startTime = null;
            let endTime = null;
            
            for (const pattern of timePatterns) {
                const match = segment.match(pattern);
                if (match) {
                    if (pattern.source.includes('([ap]m?)')) {
                        // 12-hour format with AM/PM
                        const [, startHour, startMin = '00', startPeriod = 'pm', 
                               endHour, endMin = '00', endPeriod] = match;
                        
                        startTime = convertTo24Hour(startHour, startMin, startPeriod || endPeriod);
                        endTime = convertTo24Hour(endHour, endMin, endPeriod || startPeriod);
                    } else {
                        // 24-hour format
                        const [, startHour, startMin = '00', endHour, endMin = '00'] = match;
                        startTime = `${startHour.padStart(2, '0')}:${startMin}`;
                        endTime = `${endHour.padStart(2, '0')}:${endMin}`;
                    }
                    break;
                }
            }
            
            if (!startTime || !endTime) {
                return null; // No valid times found
            }
            
            return {
                days: matchedDays,
                startTime: startTime,
                endTime: endTime
            };
        }

        function convertTo24Hour(hour, minute, period) {
            hour = parseInt(hour);
            minute = minute || '00';
            
            if (period.toLowerCase().includes('p') && hour !== 12) {
                hour += 12;
            } else if (period.toLowerCase().includes('a') && hour === 12) {
                hour = 0;
            }
            
            return `${hour.toString().padStart(2, '0')}:${minute}`;
        }

        function applyParsedResults(results, isEdit) {
            const gridId = isEdit ? 'edit-happy-hour-grid' : 'happy-hour-grid';
            const grid = document.getElementById(gridId);
            
            if (!grid) return;
            
            for (const result of results) {
                for (const day of result.days) {
                    const row = grid.querySelector(`[data-day="${day}"]`);
                    if (row) {
                        const startInput = row.querySelector('.hh-start-time');
                        const endInput = row.querySelector('.hh-end-time');
                        
                        if (startInput) startInput.value = result.startTime;
                        if (endInput) endInput.value = result.endTime;
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Set random header image (this will automatically load the saved position for that image)
            setRandomHeaderImage();
            
            // Add time input event listeners
            addTimeInputListeners();
            
            // Initialize theme from localStorage
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
            } else {
                document.body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
            }

            window.restaurantApp = new RestaurantApp();
            window.restaurantEditor = new RestaurantEditor();
            window.addEditButtonsToRestaurants = addEditButtonsToRestaurants;
            
            // Happy Hour Grid is already initialized in HTML
            
            // Mobile optimizations
            initializeMobileFeatures();
        });

        function initializeMobileFeatures() {
            // Prevent double-tap zoom on buttons
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Handle mobile keyboard hiding/showing
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    // Adjust modal height when keyboard appears
                    const modal = document.querySelector('.modal:not(.hidden)');
                    if (modal) {
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.style.maxHeight = `${window.visualViewport.height * 0.9}px`;
                        }
                    }
                });
            }

            // Add pull-to-refresh functionality (simple version)
            let startY = 0;
            let currentY = 0;
            let pullDistance = 0;
            const pullThreshold = 100;

            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (window.scrollY === 0 && startY) {
                    currentY = e.touches[0].pageY;
                    pullDistance = currentY - startY;
                    
                    if (pullDistance > 0 && pullDistance < pullThreshold) {
                        // Visual feedback could be added here
                        e.preventDefault();
                    }
                }
            });

            document.addEventListener('touchend', () => {
                if (pullDistance > pullThreshold && window.restaurantApp) {
                    // Refresh current view
                    if (window.restaurantApp.currentView === 'database') {
                        window.restaurantApp.loadRestaurants();
                    } else if (window.restaurantApp.currentView === 'happyhour') {
                        window.restaurantApp.loadHappyHours();
                    }
                }
                startY = 0;
                pullDistance = 0;
            });

            // Optimize touch scrolling
            document.addEventListener('touchmove', function(e) {
                // Allow scrolling within scrollable containers
                const target = e.target.closest('.modal-content, #restaurants-list, #happy-hour-list');
                if (!target) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Scratchpad functionality
        let scratchpadSaveTimeout;
        let scratchpadInitialized = false;

        async function openPendingModal() {
            document.getElementById('pending-modal').classList.remove('hidden');
            await loadScratchpadText();
        }

        function closePendingModal() {
            document.getElementById('pending-modal').classList.add('hidden');
        }

        async function loadScratchpadText() {
            const textarea = document.getElementById('scratchpad-text');
            
            try {
                console.log('Loading scratchpad...');
                const response = await fetch('/api/scratchpad');
                const data = await response.json();
                console.log('Loaded scratchpad data:', data);
                textarea.value = data.content || '';
            } catch (error) {
                console.error('Error loading scratchpad:', error);
                textarea.value = '';
            }
            
            // Only add event listener once
            if (!scratchpadInitialized) {
                textarea.addEventListener('input', function() {
                    const statusEl = document.getElementById('scratchpad-status');
                    statusEl.textContent = 'Saving...';
                    statusEl.style.color = '#f59e0b';
                    
                    clearTimeout(scratchpadSaveTimeout);
                    scratchpadSaveTimeout = setTimeout(async () => {
                        try {
                            console.log('Saving scratchpad content:', this.value);
                            const response = await fetch('/api/scratchpad', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ content: this.value }),
                            });
                            const result = await response.json();
                            console.log('Save response:', result);
                            statusEl.textContent = 'Saved to database';
                            statusEl.style.color = '#10b981';
                            console.log('Scratchpad saved successfully');
                        } catch (error) {
                            statusEl.textContent = 'Error saving';
                            statusEl.style.color = '#ef4444';
                            console.error('Error saving scratchpad:', error);
                        }
                    }, 1000); // Save after 1 second of no typing
                });
                scratchpadInitialized = true;
            }
        }

        async function clearScratchpad() {
            if (confirm('Are you sure you want to clear all scratchpad text?')) {
                const textarea = document.getElementById('scratchpad-text');
                textarea.value = '';
                
                try {
                    await fetch('/api/scratchpad', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: '' }),
                    });
                    console.log('Scratchpad cleared');
                } catch (error) {
                    console.error('Error clearing scratchpad:', error);
                }
            }
        }

        // Google Maps Import Function
        async function importFromMaps() {
            const urlInput = document.getElementById('maps-url');
            const statusDiv = document.getElementById('import-status');
            const url = urlInput.value.trim();
            
            if (!url) {
                statusDiv.textContent = 'Please paste a Google Maps link';
                statusDiv.style.color = '#ef4444';
                return;
            }
            
            statusDiv.textContent = 'Importing...';
            statusDiv.style.color = '#6b7280';
            
            try {
                const data = extractDataFromMapsUrl(url);
                
                if (data.name) {
                    document.getElementById('name').value = data.name;
                }
                if (data.latitude && data.longitude) {
                    document.getElementById('latitude').value = data.latitude;
                    document.getElementById('longitude').value = data.longitude;
                }
                if (data.borough) {
                    document.getElementById('borough').value = data.borough;
                }
                if (data.neighborhood) {
                    document.getElementById('neighborhood').value = data.neighborhood;
                }
                if (data.mapLink) {
                    document.getElementById('maps-link-input').value = data.mapLink;
                }
                
                let statusMessage = '';
                if (data.name) {
                    statusMessage = `✓ Imported: ${data.name}`;
                    if (data.neighborhood) {
                        statusMessage += ` (${data.neighborhood})`;
                    }
                } else {
                    statusMessage = '⚠️ Could not extract restaurant name';
                }
                
                statusDiv.textContent = statusMessage;
                statusDiv.style.color = data.name ? '#10b981' : '#f59e0b';
                
                // Clear the input
                urlInput.value = '';
                
            } catch (error) {
                console.error('Import error:', error);
                statusDiv.textContent = '❌ Error importing from Google Maps';
                statusDiv.style.color = '#ef4444';
            }
        }
        
        function extractDataFromMapsUrl(url) {
            const data = {};
            
            try {
                // Handle different Google Maps URL formats
                
                // Format 1: https://maps.google.com/maps/place/Restaurant+Name/@lat,lng
                let match = url.match(/place\/([^/@]+).*@(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (match) {
                    data.name = decodeURIComponent(match[1].replace(/\+/g, ' '));
                    data.latitude = parseFloat(match[2]);
                    data.longitude = parseFloat(match[3]);
                }
                
                // Format 2: https://maps.app.goo.gl/... (would need to be followed, but store as map link)
                else if (url.includes('maps.app.goo.gl') || url.includes('goo.gl/maps')) {
                    // For shortened URLs, we can't extract much without following the redirect
                    // But we can store the link itself
                    data.mapLink = url;
                }
                
                // Format 3: https://www.google.com/maps/place/Restaurant+Name
                else {
                    match = url.match(/place\/([^/@?]+)/);
                    if (match) {
                        data.name = decodeURIComponent(match[1].replace(/\+/g, ' '));
                    }
                }
                
                // Try to extract coordinates from various URL patterns
                if (!data.latitude || !data.longitude) {
                    match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (match) {
                        data.latitude = parseFloat(match[1]);
                        data.longitude = parseFloat(match[2]);
                    }
                }
                
                // Basic borough detection from coordinates (rough approximation)
                if (data.latitude && data.longitude) {
                    data.borough = getBoroughFromCoordinates(data.latitude, data.longitude);
                    data.neighborhood = getNeighborhoodFromCoordinates(data.latitude, data.longitude);
                }
                
                // Try to extract neighborhood from URL path or query params
                if (!data.neighborhood) {
                    data.neighborhood = extractNeighborhoodFromUrl(url);
                }
                
                // Store the original URL as map link if we don't have one
                if (!data.mapLink) {
                    data.mapLink = url;
                }
                
            } catch (error) {
                console.error('Error parsing Google Maps URL:', error);
            }
            
            return data;
        }
        
        function getBoroughFromCoordinates(lat, lng) {
            // Rough borough boundaries for NYC
            // These are approximate and not precise
            if (lat >= 40.7 && lat <= 40.8 && lng >= -74.0 && lng <= -73.95) {
                return 'Manhattan';
            } else if (lat >= 40.6 && lat <= 40.75 && lng >= -74.05 && lng <= -73.85) {
                return 'Brooklyn';
            } else if (lat >= 40.7 && lat <= 40.8 && lng >= -73.95 && lng <= -73.7) {
                return 'Queens';
            } else if (lat >= 40.8 && lat <= 40.9 && lng >= -73.9 && lng <= -73.8) {
                return 'Bronx';
            } else if (lat >= 40.5 && lat <= 40.65 && lng >= -74.25 && lng <= -74.05) {
                return 'Staten Island';
            }
            return null;
        }
        
        function getNeighborhoodFromCoordinates(lat, lng) {
            // Common NYC neighborhood boundaries (approximate)
            // Brooklyn neighborhoods
            if (lat >= 40.7 && lat <= 40.72 && lng >= -73.97 && lng <= -73.94) {
                return 'Williamsburg';
            } else if (lat >= 40.69 && lat <= 40.71 && lng >= -73.97 && lng <= -73.95) {
                return 'East Williamsburg';
            } else if (lat >= 40.72 && lat <= 40.74 && lng >= -73.96 && lng <= -73.93) {
                return 'Greenpoint';
            } else if (lat >= 40.68 && lat <= 40.7 && lng >= -73.99 && lng <= -73.96) {
                return 'DUMBO';
            } else if (lat >= 40.69 && lat <= 40.71 && lng >= -73.99 && lng <= -73.97) {
                return 'Brooklyn Heights';
            } else if (lat >= 40.67 && lat <= 40.69 && lng >= -73.99 && lng <= -73.97) {
                return 'Carroll Gardens';
            } else if (lat >= 40.66 && lat <= 40.68 && lng >= -73.99 && lng <= -73.97) {
                return 'Red Hook';
            } else if (lat >= 40.65 && lat <= 40.67 && lng >= -73.99 && lng <= -73.97) {
                return 'Gowanus';
            } else if (lat >= 40.67 && lat <= 40.69 && lng >= -73.97 && lng <= -73.95) {
                return 'Park Slope';
            } else if (lat >= 40.65 && lat <= 40.67 && lng >= -73.97 && lng <= -73.95) {
                return 'Prospect Heights';
            } else if (lat >= 40.64 && lat <= 40.66 && lng >= -73.97 && lng <= -73.95) {
                return 'Prospect Lefferts Gardens';
            } else if (lat >= 40.63 && lat <= 40.65 && lng >= -73.97 && lng <= -73.95) {
                return 'Flatbush';
            } else if (lat >= 40.66 && lat <= 40.68 && lng >= -73.95 && lng <= -73.93) {
                return 'Crown Heights';
            } else if (lat >= 40.67 && lat <= 40.69 && lng >= -73.93 && lng <= -73.91) {
                return 'Bedford-Stuyvesant';
            } else if (lat >= 40.69 && lat <= 40.71 && lng >= -73.93 && lng <= -73.91) {
                return 'Bushwick';
            }
            
            // Manhattan neighborhoods
            else if (lat >= 40.75 && lat <= 40.77 && lng >= -73.99 && lng <= -73.97) {
                return 'Midtown';
            } else if (lat >= 40.74 && lat <= 40.76 && lng >= -73.99 && lng <= -73.97) {
                return 'Chelsea';
            } else if (lat >= 40.73 && lat <= 40.75 && lng >= -73.99 && lng <= -73.97) {
                return 'Union Square';
            } else if (lat >= 40.72 && lat <= 40.74 && lng >= -73.99 && lng <= -73.97) {
                return 'East Village';
            } else if (lat >= 40.72 && lat <= 40.74 && lng >= -74.01 && lng <= -73.99) {
                return 'West Village';
            } else if (lat >= 40.71 && lat <= 40.73 && lng >= -74.01 && lng <= -73.99) {
                return 'SoHo';
            } else if (lat >= 40.71 && lat <= 40.73 && lng >= -73.99 && lng <= -73.97) {
                return 'NoLiTa';
            } else if (lat >= 40.71 && lat <= 40.73 && lng >= -73.99 && lng <= -73.97) {
                return 'Lower East Side';
            } else if (lat >= 40.7 && lat <= 40.72 && lng >= -74.01 && lng <= -73.99) {
                return 'Tribeca';
            } else if (lat >= 40.7 && lat <= 40.72 && lng >= -74.02 && lng <= -74.0) {
                return 'Financial District';
            }
            
            // Queens neighborhoods
            else if (lat >= 40.74 && lat <= 40.76 && lng >= -73.95 && lng <= -73.93) {
                return 'Long Island City';
            } else if (lat >= 40.75 && lat <= 40.77 && lng >= -73.93 && lng <= -73.91) {
                return 'Astoria';
            } else if (lat >= 40.74 && lat <= 40.76 && lng >= -73.91 && lng <= -73.89) {
                return 'Sunnyside';
            } else if (lat >= 40.74 && lat <= 40.76 && lng >= -73.89 && lng <= -73.87) {
                return 'Woodside';
            }
            
            return null;
        }
        
        function extractNeighborhoodFromUrl(url) {
            // Try to extract neighborhood from URL components
            // Sometimes Google Maps URLs contain neighborhood info in the path
            
            // Decode URL first
            const decodedUrl = decodeURIComponent(url);
            
            // Common neighborhood patterns in URLs
            const neighborhoodPatterns = [
                // Brooklyn
                'williamsburg', 'east williamsburg', 'greenpoint', 'dumbo', 'brooklyn heights',
                'carroll gardens', 'red hook', 'gowanus', 'park slope', 'prospect heights',
                'prospect lefferts gardens', 'flatbush', 'crown heights', 'bedford-stuyvesant',
                'bed-stuy', 'bushwick', 'sunset park', 'bay ridge', 'bensonhurst', 'coney island',
                
                // Manhattan
                'midtown', 'chelsea', 'union square', 'east village', 'west village', 'soho',
                'nolita', 'lower east side', 'les', 'tribeca', 'financial district', 'fidi',
                'upper west side', 'uws', 'upper east side', 'ues', 'harlem', 'washington heights',
                'inwood', 'gramercy', 'flatiron', 'murray hill', 'kips bay', 'hell\'s kitchen',
                
                // Queens
                'long island city', 'lic', 'astoria', 'sunnyside', 'woodside', 'jackson heights',
                'elmhurst', 'corona', 'flushing', 'forest hills', 'rego park', 'ridgewood',
                
                // Bronx
                'fordham', 'bronx', 'south bronx', 'mott haven', 'hunts point', 'yankee stadium',
                
                // Staten Island
                'st. george', 'stapleton', 'new dorp', 'tottenville'
            ];
            
            // Check if any neighborhood appears in the URL
            for (let neighborhood of neighborhoodPatterns) {
                if (decodedUrl.toLowerCase().includes(neighborhood.toLowerCase())) {
                    // Return proper capitalization
                    return neighborhood.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                }
            }
            
            return null;
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
            }
        });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available, show update notification
                                    console.log('New content available! Please refresh.');
                                    // You could show a toast notification here
                                }
                            });
                        });
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or notification
            // You could add a button to trigger installation here
        });

        // Handle PWA installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA was installed');
            deferredPrompt = null;
        });

        // Function to trigger PWA install (call this from a button)
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the PWA install prompt');
                    } else {
                        console.log('User dismissed the PWA install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }
    </script>
</body>
</html>
